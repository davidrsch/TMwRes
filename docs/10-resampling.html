<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Max Kuhn, y Julia Silge">
<title>Modelado Ordenado con R - 10&nbsp; Resampling for Evaluating Performance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./11-comparing-models.html" rel="next">
<link href="./09-judging-model-effectiveness.html" rel="prev">
<link href="./images/cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="TMwR.css">
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10-resampling.html">TOOLS FOR CREATING EFFECTIVE MODELS</a></li><li class="breadcrumb-item"><a href="./10-resampling.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modelado Ordenado con R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/davidrsch/TMwRes" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello World</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">INTRODUCTION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-software-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Software for modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A Tidyverse Primer</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-base-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Review of R Modeling Fundamentals</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">MODELING BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-ames.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Ames Housing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-data-spending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spending our Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-fitting-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Fitting Models with parsnip</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-the-model-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">A Model Workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-feature-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Feature Engineering with recipes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-judging-model-effectiveness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Judging Model Effectiveness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">TOOLS FOR CREATING EFFECTIVE MODELS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-resampling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-comparing-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing Models with Resampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-tuning-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Tuning and the Dangers of Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-iterative-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Iterative Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-workflow-sets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Screening Many Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">BEYOND THE BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-dimensionality-reduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensionality Reduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-encoding-categorical-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Encoding Categorical Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-explaining-models-and-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-when-should-you-trust-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-ensemble-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-inferential-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Inferential Analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pre-proc-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Recommended Preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#resampling-resubstition" id="toc-resampling-resubstition" class="nav-link active" data-scroll-target="#resampling-resubstition"><span class="header-section-number">10.1</span> The Resubstitution Approach</a></li>
  <li>
<a href="#resampling-methods" id="toc-resampling-methods" class="nav-link" data-scroll-target="#resampling-methods"><span class="header-section-number">10.2</span> Resampling Methods</a>
  <ul class="collapse">
<li><a href="#cv" id="toc-cv" class="nav-link" data-scroll-target="#cv"><span class="header-section-number">10.2.1</span> Cross-validation</a></li>
  <li><a href="#repeated-cross-validation" id="toc-repeated-cross-validation" class="nav-link" data-scroll-target="#repeated-cross-validation">Repeated cross-validation</a></li>
  <li><a href="#leave-one-out-cross-validation" id="toc-leave-one-out-cross-validation" class="nav-link" data-scroll-target="#leave-one-out-cross-validation">Leave-one-out cross-validation</a></li>
  <li><a href="#monte-carlo-cross-validation" id="toc-monte-carlo-cross-validation" class="nav-link" data-scroll-target="#monte-carlo-cross-validation">Monte Carlo cross-validation</a></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation"><span class="header-section-number">10.2.2</span> Validation sets</a></li>
  <li><a href="#bootstrap" id="toc-bootstrap" class="nav-link" data-scroll-target="#bootstrap"><span class="header-section-number">10.2.3</span> Bootstrapping</a></li>
  <li><a href="#rolling" id="toc-rolling" class="nav-link" data-scroll-target="#rolling"><span class="header-section-number">10.2.4</span> Rolling forecasting origin resampling</a></li>
  </ul>
</li>
  <li><a href="#resampling-performance" id="toc-resampling-performance" class="nav-link" data-scroll-target="#resampling-performance"><span class="header-section-number">10.3</span> Estimating Performance</a></li>
  <li><a href="#parallel" id="toc-parallel" class="nav-link" data-scroll-target="#parallel"><span class="header-section-number">10.4</span> Parallel Processing</a></li>
  <li><a href="#extract" id="toc-extract" class="nav-link" data-scroll-target="#extract"><span class="header-section-number">10.5</span> Saving the Resampled Objects</a></li>
  <li><a href="#resampling-summary" id="toc-resampling-summary" class="nav-link" data-scroll-target="#resampling-summary"><span class="header-section-number">10.6</span> Chapter Summary</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/davidrsch/TMwRes/edit/main/10-resampling.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/davidrsch/TMwRes/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="resampling" class="quarto-section-identifier"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>We have already covered several pieces that must be put together to evaluate the performance of a model. Chapter @ref(performance) described statistics for measuring model performance. Chapter @ref(splitting) introduced the idea of data spending, and we recommended the test set for obtaining an unbiased estimate of performance. However, we usually need to understand the performance of a model or even multiple models <em>before using the test set</em>.</p>
<div class="rmdwarning">
<p>Typically we can’t decide on which final model to use with the test set before first assessing model performance. There is a gap between our need to measure performance reliably and the data splits (training and testing) we have available.</p>
</div>
<p>In this chapter, we describe an approach called resampling that can fill this gap. Resampling estimates of performance can generalize to new data in a similar way as estimates from a test set. The next chapter complements this one by demonstrating statistical methods that compare resampling results.</p>
<p>In order to fully appreciate the value of resampling, let’s first take a look the resubstitution approach, which can often fail.</p>
<section id="resampling-resubstition" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="resampling-resubstition">
<span class="header-section-number">10.1</span> The Resubstitution Approach</h2>
<p>When we measure performance on the same data that we used for training (as opposed to new data or testing data), we say we have <em>resubstituted</em> the data. Let’s again use the Ames housing data to demonstrate these concepts. Section @ref(recipes-summary) summarizes the current state of our Ames analysis. It includes a recipe object named <code>ames_rec</code>, a linear model, and a workflow using that recipe and model called <code>lm_wflow</code>. This workflow was fit on the training set, resulting in <code>lm_fit</code>.</p>
<p>For a comparison to this linear model, we can also fit a different type of model. <em>Random forests</em> are a tree ensemble method that operates by creating a large number of decision trees from slightly different versions of the training set <span class="citation" data-cites="breiman2001random">(<a href="#ref-breiman2001random" role="doc-biblioref">Breiman 2001</a>)</span>. This collection of trees makes up the ensemble. When predicting a new sample, each ensemble member makes a separate prediction. These are averaged to create the final ensemble prediction for the new data point.</p>
<p>Random forest models are very powerful, and they can emulate the underlying data patterns very closely. While this model can be computationally intensive, it is very low maintenance; very little preprocessing is required (as documented in Appendix @ref(pre-proc-table)).</p>
<p>Using the same predictor set as the linear model (without the extra preprocessing steps), we can fit a random forest model to the training set via the <code>"ranger"</code> engine (which uses the <span class="pkg">ranger</span> R package for computation). This model requires no preprocessing, so a simple formula can be used:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rf_model</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rand_forest</span><span class="op">(</span>trees <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_wflow</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Neighborhood</span> <span class="op">+</span> <span class="va">Gr_Liv_Area</span> <span class="op">+</span> <span class="va">Year_Built</span> <span class="op">+</span> <span class="va">Bldg_Type</span> <span class="op">+</span> </span>
<span>      <span class="va">Latitude</span> <span class="op">+</span> <span class="va">Longitude</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">rf_model</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">rf_fit</span> <span class="op">&lt;-</span> <span class="va">rf_wflow</span> <span class="op">%&gt;%</span> <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ames_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How should we compare the linear and random forest models? For demonstration, we will predict the training set to produce what is known as an <em>apparent metric</em> or <em>resubstitution metric</em>. This function creates predictions and formats the results:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">estimate_perf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Capture the names of the `model` and `dat` objects</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.call.html">match.call</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">obj_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span>
<span>  <span class="va">data_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">data_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"ames_"</span>, <span class="st">""</span>, <span class="va">data_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Estimate these metrics:</span></span>
<span>  <span class="va">reg_metrics</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">rsq</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">bind_cols</span><span class="op">(</span><span class="va">dat</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">Sale_Price</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">reg_metrics</span><span class="op">(</span><span class="va">Sale_Price</span>, <span class="va">.pred</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">.estimator</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>object <span class="op">=</span> <span class="va">obj_name</span>, data <span class="op">=</span> <span class="va">data_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Both RMSE and <span class="math inline">\(R^2\)</span> are computed. The resubstitution statistics are:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">estimate_perf</span><span class="op">(</span><span class="va">rf_fit</span>, <span class="va">ames_train</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 4</span></span>
<span><span class="co">##   .metric .estimate object data </span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;</span></span>
<span><span class="co">## 1 rmse       0.0366 rf_fit train</span></span>
<span><span class="co">## 2 rsq        0.960  rf_fit train</span></span>
<span><span class="fu">estimate_perf</span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">ames_train</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 4</span></span>
<span><span class="co">##   .metric .estimate object data </span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;</span></span>
<span><span class="co">## 1 rmse       0.0754 lm_fit train</span></span>
<span><span class="co">## 2 rsq        0.816  lm_fit train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on these results, the random forest is much more capable of predicting the sale prices; the RMSE estimate is two-fold better than linear regression. If we needed to choose between these two models for this price prediction problem, we would probably chose the random forest because, on the log scale we are using, its RMSE is about half as large. The next step applies the random forest model to the test set for final verification:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">estimate_perf</span><span class="op">(</span><span class="va">rf_fit</span>, <span class="va">ames_test</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 4</span></span>
<span><span class="co">##   .metric .estimate object data </span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;</span></span>
<span><span class="co">## 1 rmse       0.0704 rf_fit test </span></span>
<span><span class="co">## 2 rsq        0.852  rf_fit test</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The test set RMSE estimate, 0.0704, is <em>much worse than the training set</em> value of 0.0366! Why did this happen?</p>
<p>Many predictive models are capable of learning complex trends from the data. In statistics, these are commonly referred to as <em>low bias models</em>.</p>
<div class="rmdnote">
<p>In this context, <em>bias</em> is the difference between the true pattern or relationships in data and the types of patterns that the model can emulate. Many black-box machine learning models have low bias, meaning they can reproduce complex relationships. Other models (such as linear/logistic regression, discriminant analysis, and others) are not as adaptable and are considered <em>high bias</em> models.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</div>
<p>For a low bias model, the high degree of predictive capacity can sometimes result in the model nearly memorizing the training set data. As an obvious example, consider a 1-nearest neighbor model. It will always provide perfect predictions for the training set no matter how well it truly works for other data sets. Random forest models are similar; repredicting the training set will always result in an artificially optimistic estimate of performance.</p>
<p>For both models, Table @ref(tab:rmse-results) summarizes the RMSE estimate for the training and test sets:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Performance statistics for training and test sets.</caption>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: left; empty-cells: hide; border-bottom: hidden;"></th>
<th colspan="2" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
RMSE Estimates
</div></th>
</tr>
<tr class="odd">
<th style="text-align: left;" data-quarto-table-cell-role="th">object</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">train</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>lm_fit</code></td>
<td style="text-align: right;">0.0754</td>
<td style="text-align: right;">0.0736</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>rf_fit</code></td>
<td style="text-align: right;">0.0366</td>
<td style="text-align: right;">0.0704</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Notice that the linear regression model is consistent between training and testing, because of its limited complexity.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="rmdwarning">
<p>The main takeaway from this example is that repredicting the training set will result in an artificially optimistic estimate of performance. It is a bad idea for most models.</p>
</div>
<p>If the test set should not be used immediately, and repredicting the training set is a bad idea, what should be done? Resampling methods, such as cross-validation or validation sets, are the solution.</p>
</section><section id="resampling-methods" class="level2" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="resampling-methods">
<span class="header-section-number">10.2</span> Resampling Methods</h2>
<p>Resampling methods are empirical simulation systems that emulate the process of using some data for modeling and different data for evaluation. Most resampling methods are iterative, meaning that this process is repeated multiple times. The diagram in Figure @ref(fig:resampling-scheme) illustrates how resampling methods generally operate.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/resampling.svg" class="img-fluid figure-img" style="width:85.0%" alt="A diagram of the data splitting scheme from the initial data split to resampling. The first level is the training/testing set partition. The second level of splitting takes the training set and splits it into multiple 'analysis' and 'assessment' sets (which are analogous to training and test)."></p>
<figcaption class="figure-caption">Data splitting scheme from the initial data split to resampling</figcaption></figure>
</div>
</div>
</div>
<p>Resampling is conducted only on the training set, as you see in Figure @ref(fig:resampling-scheme). The test set is not involved. For each iteration of resampling, the data are partitioned into two subsamples:</p>
<ul>
<li><p>The model is fit with the <em>analysis set</em>.</p></li>
<li><p>The model is evaluated with the <em>assessment set</em>.</p></li>
</ul>
<p>These two subsamples are somewhat analogous to training and test sets. Our language of <em>analysis</em> and <em>assessment</em> avoids confusion with the initial split of the data. These data sets are mutually exclusive. The partitioning scheme used to create the analysis and assessment sets is usually the defining characteristic of the method.</p>
<p>Suppose 20 iterations of resampling are conducted. This means that 20 separate models are fit on the analysis sets, and the corresponding assessment sets produce 20 sets of performance statistics. The final estimate of performance for a model is the average of the 20 replicates of the statistics. This average has very good generalization properties and is far better than the resubstitution estimates.</p>
<p>The next section defines several commonly used resampling methods and discusses their pros and cons.</p>
<section id="cv" class="level3" data-number="10.2.1"><h3 data-number="10.2.1" class="anchored" data-anchor-id="cv">
<span class="header-section-number">10.2.1</span> Cross-validation</h3>
<p>Cross-validation is a well established resampling method. While there are a number of variations, the most common cross-validation method is <em>V</em>-fold cross-validation. The data are randomly partitioned into <em>V</em> sets of roughly equal size (called the folds). For illustration, <em>V</em> = 3 is shown in Figure @ref(fig:cross-validation-allocation) for a data set of 30 training set points with random fold allocations. The number inside the symbols is the sample number.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/three-CV.svg" class="img-fluid figure-img" style="width:50.0%" alt="A diagram of how V-fold cross-validation randomly assigns data to folds (where V equals three). A set of thirty data points are assigned to three groups of roughly the same size."></p>
<figcaption class="figure-caption">V-fold cross-validation randomly assigns data to folds</figcaption></figure>
</div>
</div>
</div>
<p>The color of the symbols in Figure @ref(fig:cross-validation-allocation) represents their randomly assigned folds. Stratified sampling is also an option for assigning folds (previously discussed in Section @ref(splitting-methods)).</p>
<p>For three-fold cross-validation, the three iterations of resampling are illustrated in Figure @ref(fig:cross-validation). For each iteration, one fold is held out for assessment statistics and the remaining folds are substrate for the model. This process continues for each fold so that three models produce three sets of performance statistics.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/three-CV-iter.svg" class="img-fluid figure-img" style="width:70.0%" alt="A diagram of V-fold cross-validation data usage (where V equals three). For each of the three groups, the data for the fold are held out for performance while the other two are used for modeling."></p>
<figcaption class="figure-caption">V-fold cross-validation data usage</figcaption></figure>
</div>
</div>
</div>
<p>When <em>V</em> = 3, the analysis sets are 2/3 of the training set and each assessment set is a distinct 1/3. The final resampling estimate of performance averages each of the <em>V</em> replicates.</p>
<p>Using <em>V</em> = 3 is a good choice to illustrate cross-validation, but it is a poor choice in practice because it is too low to generate reliable estimates. In practice, values of <em>V</em> are most often 5 or 10; we generally prefer 10-fold cross-validation as a default because it is large enough for good results in most situations.</p>
<div class="rmdnote">
<p>What are the effects of changing <em>V</em>? Larger values result in resampling estimates with small bias but substantial variance. Smaller values of <em>V</em> have large bias but low variance. We prefer 10-fold since noise is reduced by replication, but bias is not.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
</div>
<p>The primary input is the training set data frame as well as the number of folds (defaulting to 10):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1001</span><span class="op">)</span></span>
<span><span class="va">ames_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">ames_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">ames_folds</span></span>
<span><span class="co">## #  10-fold cross-validation </span></span>
<span><span class="co">## # A tibble: 10 × 2</span></span>
<span><span class="co">##   splits             id    </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt; </span></span>
<span><span class="co">## 1 &lt;split [2107/235]&gt; Fold01</span></span>
<span><span class="co">## 2 &lt;split [2107/235]&gt; Fold02</span></span>
<span><span class="co">## 3 &lt;split [2108/234]&gt; Fold03</span></span>
<span><span class="co">## 4 &lt;split [2108/234]&gt; Fold04</span></span>
<span><span class="co">## 5 &lt;split [2108/234]&gt; Fold05</span></span>
<span><span class="co">## 6 &lt;split [2108/234]&gt; Fold06</span></span>
<span><span class="co">## # ℹ 4 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The column named <code>splits</code> contains the information on how to split the data (similar to the object used to create the initial training/test partition). While each row of <code>splits</code> has an embedded copy of the entire training set, R is smart enough not to make copies of the data in memory.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> The print method inside of the tibble shows the frequency of each: <code>[2107/235]</code> indicates that about two thousand samples are in the analysis set and 235 are in that particular assessment set.</p>
<p>These objects also always contain a character column called <code>id</code> that labels the partition.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>To manually retrieve the partitioned data, the <code>analysis()</code> and <code>assessment()</code> functions return the corresponding data frames:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># For the first fold:</span></span>
<span><span class="va">ames_folds</span><span class="op">$</span><span class="va">splits</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">analysis</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## [1] 2107   74</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <span class="pkg">tidymodels</span> packages, such as <a href="https://tune.tidymodels.org/"><span class="pkg">tune</span></a>, contain high-level user interfaces so that functions like <code>analysis()</code> are not generally needed for day-to-day work. Section @ref(resampling-performance) demonstrates a function to fit a model over these resamples.</p>
<p>There are a variety of cross-validation variations; we’ll go through the most important ones.</p>
</section><section id="repeated-cross-validation" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="repeated-cross-validation">Repeated cross-validation</h3>
<p>The most important variation on cross-validation is repeated <em>V</em>-fold cross-validation. Depending on data size or other characteristics, the resampling estimate produced by <em>V</em>-fold cross-validation may be excessively noisy.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> As with many statistical problems, one way to reduce noise is to gather more data. For cross-validation, this means averaging more than <em>V</em> statistics.</p>
<p>To create <em>R</em> repeats of <em>V</em>-fold cross-validation, the same fold generation process is done <em>R</em> times to generate <em>R</em> collections of <em>V</em> partitions. Now, instead of averaging <em>V</em> statistics, <span class="math inline">\(V \times R\)</span> statistics produce the final resampling estimate. Due to the Central Limit Theorem, the summary statistics from each model tend toward a normal distribution, as long as we have a lot of data relative to <span class="math inline">\(V \times R\)</span>.</p>
<p>Consider the Ames data. On average, 10-fold cross-validation uses assessment sets that contain roughly 234 properties. If RMSE is the statistic of choice, we can denote that estimate’s standard deviation as <span class="math inline">\(\sigma\)</span>. With simple 10-fold cross-validation, the standard error of the mean RMSE is <span class="math inline">\(\sigma/\sqrt{10}\)</span>. If this is too noisy, repeats reduce the standard error to <span class="math inline">\(\sigma/\sqrt{10R}\)</span>. For 10-fold cross-validation with <span class="math inline">\(R\)</span> replicates, the plot in Figure @ref(fig:variance-reduction) shows how quickly the standard error<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> decreases with replicates.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/variance-reduction-1.png" class="img-fluid figure-img" alt="The relationship between the relative variance in performance estimates versus the number of cross-validation repeats. As the repeats increase, the variance is reduced in a harmonically decreasing pattern with diminishing returns for large number of replicates." width="672"></p>
<figcaption class="figure-caption">Relationship between the relative variance in performance estimates versus the number of cross-validation repeats</figcaption></figure>
</div>
</div>
</div>
<p>Larger numbers of replicates tend to have less impact on the standard error. However, if the baseline value of <span class="math inline">\(\sigma\)</span> is impractically large, the diminishing returns on replication may still be worth the extra computational costs.</p>
<p>To create repeats, invoke <code>vfold_cv()</code> with an additional argument <code>repeats</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">vfold_cv</span><span class="op">(</span><span class="va">ames_train</span>, v <span class="op">=</span> <span class="fl">10</span>, repeats <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">## #  10-fold cross-validation repeated 5 times </span></span>
<span><span class="co">## # A tibble: 50 × 3</span></span>
<span><span class="co">##   splits             id      id2   </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;   &lt;chr&gt; </span></span>
<span><span class="co">## 1 &lt;split [2107/235]&gt; Repeat1 Fold01</span></span>
<span><span class="co">## 2 &lt;split [2107/235]&gt; Repeat1 Fold02</span></span>
<span><span class="co">## 3 &lt;split [2108/234]&gt; Repeat1 Fold03</span></span>
<span><span class="co">## 4 &lt;split [2108/234]&gt; Repeat1 Fold04</span></span>
<span><span class="co">## 5 &lt;split [2108/234]&gt; Repeat1 Fold05</span></span>
<span><span class="co">## 6 &lt;split [2108/234]&gt; Repeat1 Fold06</span></span>
<span><span class="co">## # ℹ 44 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="leave-one-out-cross-validation" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="leave-one-out-cross-validation">Leave-one-out cross-validation</h3>
<p>One variation of cross-validation is leave-one-out (LOO) cross-validation. If there are <span class="math inline">\(n\)</span> training set samples, <span class="math inline">\(n\)</span> models are fit using <span class="math inline">\(n-1\)</span> rows of the training set. Each model predicts the single excluded data point. At the end of resampling, the <span class="math inline">\(n\)</span> predictions are pooled to produce a single performance statistic.</p>
<p>Leave-one-out methods are deficient compared to almost any other method. For anything but pathologically small samples, LOO is computationally excessive, and it may not have good statistical properties. Although the <span class="pkg">rsample</span> package contains a <code>loo_cv()</code> function, these objects are not generally integrated into the broader tidymodels frameworks.</p>
</section><section id="monte-carlo-cross-validation" class="level3 unnumbered"><h3 class="unnumbered anchored" data-anchor-id="monte-carlo-cross-validation">Monte Carlo cross-validation</h3>
<p>Another variant of <em>V</em>-fold cross-validation is Monte Carlo cross-validation (MCCV, <span class="citation" data-cites="xu2001monte">Xu and Liang (<a href="#ref-xu2001monte" role="doc-biblioref">2001</a>)</span>). Like <em>V</em>-fold cross-validation, it allocates a fixed proportion of data to the assessment sets. The difference between MCCV and regular cross-validation is that, for MCCV, this proportion of the data is randomly selected each time. This results in assessment sets that are not mutually exclusive. To create these resampling objects:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">mc_cv</span><span class="op">(</span><span class="va">ames_train</span>, prop <span class="op">=</span> <span class="fl">9</span><span class="op">/</span><span class="fl">10</span>, times <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">## # Monte Carlo cross-validation (0.9/0.1) with 20 resamples  </span></span>
<span><span class="co">## # A tibble: 20 × 2</span></span>
<span><span class="co">##   splits             id        </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;     </span></span>
<span><span class="co">## 1 &lt;split [2107/235]&gt; Resample01</span></span>
<span><span class="co">## 2 &lt;split [2107/235]&gt; Resample02</span></span>
<span><span class="co">## 3 &lt;split [2107/235]&gt; Resample03</span></span>
<span><span class="co">## 4 &lt;split [2107/235]&gt; Resample04</span></span>
<span><span class="co">## 5 &lt;split [2107/235]&gt; Resample05</span></span>
<span><span class="co">## 6 &lt;split [2107/235]&gt; Resample06</span></span>
<span><span class="co">## # ℹ 14 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="validation" class="level3" data-number="10.2.2"><h3 data-number="10.2.2" class="anchored" data-anchor-id="validation">
<span class="header-section-number">10.2.2</span> Validation sets</h3>
<p>In Section @ref(what-about-a-validation-set), we briefly discussed the use of a validation set, a single partition that is set aside to estimate performance separate from the test set. When using a validation set, the initial available data set is split into a training set, a validation set, and a test set (see Figure @ref(fig:three-way-split)).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/validation.svg" class="img-fluid figure-img" style="width:50.0%" alt="A three-way initial split into training, testing, and validation sets."></p>
<figcaption class="figure-caption">A three-way initial split into training, testing, and validation sets</figcaption></figure>
</div>
</div>
</div>
<p>Validation sets are often used when the original pool of data is very large. In this case, a single large partition may be adequate to characterize model performance without having to do multiple resampling iterations.</p>
<p>With the <span class="pkg">rsample</span> package, a validation set is like any other resampling object; this type is different only in that it has a single iteration.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> Figure @ref(fig:validation-split) shows this scheme.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/validation-alt.svg" class="img-fluid figure-img" style="width:45.0%" alt="A two-way initial split into training and testing with an additional validation set split on the training set."></p>
<figcaption class="figure-caption">A two-way initial split into training and testing with an additional validation set split on the training set</figcaption></figure>
</div>
</div>
</div>
<p>To build on the code from Section @ref(what-about-a-validation-set), the function <code>validation_set()</code> can take the results of <code>initial_validation_split()</code> and convert it to an rset object that is similar to the ones produced by functions such as <code>vfold_cv()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Previously:</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">52</span><span class="op">)</span></span>
<span><span class="co"># To put 60% into training, 20% in validation, and 20% in testing:</span></span>
<span><span class="va">ames_val_split</span> <span class="op">&lt;-</span> <span class="fu">initial_validation_split</span><span class="op">(</span><span class="va">ames</span>, prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ames_val_split</span></span>
<span><span class="co">## &lt;Training/Validation/Testing/Total&gt;</span></span>
<span><span class="co">## &lt;1758/586/586/2930&gt;</span></span>
<span></span>
<span><span class="co"># Object used for resampling: </span></span>
<span><span class="va">val_set</span> <span class="op">&lt;-</span> <span class="fu">validation_set</span><span class="op">(</span><span class="va">ames_val_split</span><span class="op">)</span></span>
<span><span class="va">val_set</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##   splits             id        </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;     </span></span>
<span><span class="co">## 1 &lt;split [1758/586]&gt; validation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you’ll see in Section @ref(resampling-performance), the <code>fit_resamples()</code> function will be used to compute correct estimates of performance using resampling. The <code>val_set</code> object can be used in in this and other functions even though it is a single “resample” of the data.</p>
</section><section id="bootstrap" class="level3" data-number="10.2.3"><h3 data-number="10.2.3" class="anchored" data-anchor-id="bootstrap">
<span class="header-section-number">10.2.3</span> Bootstrapping</h3>
<p>Bootstrap resampling was originally invented as a method for approximating the sampling distribution of statistics whose theoretical properties are intractable <span class="citation" data-cites="davison1997bootstrap">(<a href="#ref-davison1997bootstrap" role="doc-biblioref">Davison and Hinkley 1997</a>)</span>. Using it to estimate model performance is a secondary application of the method.</p>
<p>A bootstrap sample of the training set is a sample that is the same size as the training set but is drawn <em>with replacement</em>. This means that some training set data points are selected multiple times for the analysis set. Each data point has a 63.2% chance of inclusion in the training set at least once. The assessment set contains all of the training set samples that were not selected for the analysis set (on average, with 36.8% of the training set). When bootstrapping, the assessment set is often called the <em>out-of-bag</em> sample.</p>
<p>For a training set of 30 samples, a schematic of three bootstrap samples is shown in Figure@ref(fig:bootstrapping).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/bootstraps.svg" class="img-fluid figure-img" style="width:80.0%" alt="A diagram of bootstrapping data usage. For each bootstrap resample, the analysis set is the same size as the training set (due to sampling with replacement) and the assessment set consists of samples not in the analysis set."></p>
<figcaption class="figure-caption">Bootstrapping data usage</figcaption></figure>
</div>
</div>
</div>
<p>Note that the sizes of the assessment sets vary.</p>
<p>Using the <span class="pkg">rsample</span> package, we can create such bootstrap resamples:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">bootstraps</span><span class="op">(</span><span class="va">ames_train</span>, times <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">## # Bootstrap sampling </span></span>
<span><span class="co">## # A tibble: 5 × 2</span></span>
<span><span class="co">##   splits             id        </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;     </span></span>
<span><span class="co">## 1 &lt;split [2342/867]&gt; Bootstrap1</span></span>
<span><span class="co">## 2 &lt;split [2342/869]&gt; Bootstrap2</span></span>
<span><span class="co">## 3 &lt;split [2342/859]&gt; Bootstrap3</span></span>
<span><span class="co">## 4 &lt;split [2342/858]&gt; Bootstrap4</span></span>
<span><span class="co">## 5 &lt;split [2342/873]&gt; Bootstrap5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Bootstrap samples produce performance estimates that have very low variance (unlike cross-validation) but have significant pessimistic bias. This means that, if the true accuracy of a model is 90%, the bootstrap would tend to estimate the value to be less than 90%. The amount of bias cannot be empirically determined with sufficient accuracy. Additionally, the amount of bias changes over the scale of the performance metric. For example, the bias is likely to be different when the accuracy is 90% versus when it is 70%.</p>
<p>The bootstrap is also used inside of many models. For example, the random forest model mentioned earlier contained 1,000 individual decision trees. Each tree was the product of a different bootstrap sample of the training set.</p>
</section><section id="rolling" class="level3" data-number="10.2.4"><h3 data-number="10.2.4" class="anchored" data-anchor-id="rolling">
<span class="header-section-number">10.2.4</span> Rolling forecasting origin resampling</h3>
<p>When the data have a strong time component, a resampling method should support modeling to estimate seasonal and other temporal trends within the data. A technique that randomly samples values from the training set can disrupt the model’s ability to estimate these patterns.</p>
<p>Rolling forecast origin resampling <span class="citation" data-cites="hyndman2018forecasting">(<a href="#ref-hyndman2018forecasting" role="doc-biblioref">Hyndman and Athanasopoulos 2018</a>)</span> provides a method that emulates how time series data is often partitioned in practice, estimating the model with historical data and evaluating it with the most recent data. For this type of resampling, the size of the initial analysis and assessment sets are specified. The first iteration of resampling uses these sizes, starting from the beginning of the series. The second iteration uses the same data sizes but shifts over by a set number of samples.</p>
<p>To illustrate, a training set of fifteen samples was resampled with an analysis size of eight samples and an assessment set size of three. The second iteration discards the first training set sample and both data sets shift forward by one. This configuration results in five resamples, as shown in Figure@ref(fig:rolling).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="premade/rolling.svg" class="img-fluid figure-img" style="width:65.0%" alt="The data usage for rolling forecasting origin resampling. For each split, earlier data are used for modeling and a few subsequent instances are used to measure performance."></p>
<figcaption class="figure-caption">Data usage for rolling forecasting origin resampling</figcaption></figure>
</div>
</div>
</div>
<p>Here are two different configurations of this method:</p>
<ul>
<li><p>The analysis set can cumulatively grow (as opposed to remaining the same size). After the first initial analysis set, new samples can accrue without discarding the earlier data.</p></li>
<li><p>The resamples need not increment by one. For example, for large data sets, the incremental block could be a week or month instead of a day.</p></li>
</ul>
<p>For a year’s worth of data, suppose that six sets of 30-day blocks define the analysis set. For assessment sets of 30 days with a 29-day skip, we can use the <span class="pkg">rsample</span> package to specify:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">time_slices</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">365</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rolling_origin</span><span class="op">(</span>initial <span class="op">=</span> <span class="fl">6</span> <span class="op">*</span> <span class="fl">30</span>, assess <span class="op">=</span> <span class="fl">30</span>, skip <span class="op">=</span> <span class="fl">29</span>, cumulative <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_range</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="va">x</span>, first <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, last <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">map_dfr</span><span class="op">(</span><span class="va">time_slices</span><span class="op">$</span><span class="va">splits</span>, <span class="op">~</span>   <span class="fu">analysis</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">data_range</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   first  last</span></span>
<span><span class="co">##   &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">## 1     1   180</span></span>
<span><span class="co">## 2    31   210</span></span>
<span><span class="co">## 3    61   240</span></span>
<span><span class="co">## 4    91   270</span></span>
<span><span class="co">## 5   121   300</span></span>
<span><span class="co">## 6   151   330</span></span>
<span><span class="fu">map_dfr</span><span class="op">(</span><span class="va">time_slices</span><span class="op">$</span><span class="va">splits</span>, <span class="op">~</span> <span class="fu">assessment</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">data_range</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 2</span></span>
<span><span class="co">##   first  last</span></span>
<span><span class="co">##   &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">## 1   181   210</span></span>
<span><span class="co">## 2   211   240</span></span>
<span><span class="co">## 3   241   270</span></span>
<span><span class="co">## 4   271   300</span></span>
<span><span class="co">## 5   301   330</span></span>
<span><span class="co">## 6   331   360</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="resampling-performance" class="level2" data-number="10.3"><h2 data-number="10.3" class="anchored" data-anchor-id="resampling-performance">
<span class="header-section-number">10.3</span> Estimating Performance</h2>
<p>Any of the resampling methods discussed in this chapter can be used to evaluate the modeling process (including preprocessing, model fitting, etc). These methods are effective because different groups of data are used to train the model and assess the model. To reiterate, the process to use resampling is:</p>
<ol type="1">
<li><p>During resampling, the analysis set is used to preprocess the data, apply the preprocessing to itself, and use these processed data to fit the model.</p></li>
<li><p>The preprocessing statistics produced by the analysis set are applied to the assessment set. The predictions from the assessment set estimate performance on new data.</p></li>
</ol>
<p>This sequence repeats for every resample. If there are <em>B</em> resamples, there are <em>B</em> replicates of each of the performance metrics. The final resampling estimate is the average of these <em>B</em> statistics. If <em>B</em> = 1, as with a validation set, the individual statistics represent overall performance.</p>
<p>Let’s reconsider the previous random forest model contained in the <code>rf_wflow</code> object. The <code>fit_resamples()</code> function is analogous to <code>fit()</code>, but instead of having a <code>data</code> argument, <code>fit_resamples()</code> has <code>resamples</code>, which expects an <code>rset</code> object like the ones shown in this chapter. The possible interfaces to the function are:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_spec</span> <span class="op">%&gt;%</span> <span class="fu">fit_resamples</span><span class="op">(</span><span class="va">formula</span>,  <span class="va">resamples</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">model_spec</span> <span class="op">%&gt;%</span> <span class="fu">fit_resamples</span><span class="op">(</span><span class="va">recipe</span>,   <span class="va">resamples</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">workflow</span>   <span class="op">%&gt;%</span> <span class="fu">fit_resamples</span><span class="op">(</span>          <span class="va">resamples</span>, <span class="va">...</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are a number of other optional arguments, such as:</p>
<ul>
<li><p><code>metrics</code>: A metric set of performance statistics to compute. By default, regression models use RMSE and <span class="math inline">\(R^2\)</span> while classification models compute the area under the ROC curve and overall accuracy. Note that this choice also defines what predictions are produced during the evaluation of the model. For classification, if only accuracy is requested, class probability estimates are not generated for the assessment set (since they are not needed).</p></li>
<li><p><code>control</code>: A list created by <code>control_resamples()</code> with various options.</p></li>
</ul>
<p>The control arguments include:</p>
<ul>
<li><p><code>verbose</code>: A logical for printing logging.</p></li>
<li><p><code>extract</code>: A function for retaining objects from each model iteration (discussed later in this chapter).</p></li>
<li><p><code>save_pred</code>: A logical for saving the assessment set predictions.</p></li>
</ul>
<p>For our example, let’s save the predictions in order to visualize the model fit and residuals:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">keep_pred</span> <span class="op">&lt;-</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span>, save_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1003</span><span class="op">)</span></span>
<span><span class="va">rf_res</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">rf_wflow</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span>resamples <span class="op">=</span> <span class="va">ames_folds</span>, control <span class="op">=</span> <span class="va">keep_pred</span><span class="op">)</span></span>
<span><span class="va">rf_res</span></span>
<span><span class="co">## # Resampling results</span></span>
<span><span class="co">## # 10-fold cross-validation </span></span>
<span><span class="co">## # A tibble: 10 × 5</span></span>
<span><span class="co">##   splits             id     .metrics         .notes           .predictions      </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;           &lt;list&gt;            </span></span>
<span><span class="co">## 1 &lt;split [2107/235]&gt; Fold01 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [235 × 4]&gt;</span></span>
<span><span class="co">## 2 &lt;split [2107/235]&gt; Fold02 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [235 × 4]&gt;</span></span>
<span><span class="co">## 3 &lt;split [2108/234]&gt; Fold03 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [234 × 4]&gt;</span></span>
<span><span class="co">## 4 &lt;split [2108/234]&gt; Fold04 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [234 × 4]&gt;</span></span>
<span><span class="co">## 5 &lt;split [2108/234]&gt; Fold05 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [234 × 4]&gt;</span></span>
<span><span class="co">## 6 &lt;split [2108/234]&gt; Fold06 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [234 × 4]&gt;</span></span>
<span><span class="co">## # ℹ 4 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The return value is a tibble similar to the input resamples, along with some extra columns:</p>
<ul>
<li><p><code>.metrics</code> is a list column of tibbles containing the assessment set performance statistics.</p></li>
<li><p><code>.notes</code> is another list column of tibbles cataloging any warnings or errors generated during resampling. Note that errors will not stop subsequent execution of resampling.</p></li>
<li><p><code>.predictions</code> is present when <code>save_pred = TRUE</code>. This list column contains tibbles with the out-of-sample predictions.</p></li>
</ul>
<p>While these list columns may look daunting, they can be easily reconfigured using <span class="pkg">tidyr</span> or with convenience functions that tidymodels provides. For example, to return the performance metrics in a more usable format:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">collect_metrics</span><span class="op">(</span><span class="va">rf_res</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 6</span></span>
<span><span class="co">##   .metric .estimator   mean     n std_err .config             </span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">## 1 rmse    standard   0.0721    10 0.00305 Preprocessor1_Model1</span></span>
<span><span class="co">## 2 rsq     standard   0.831     10 0.0108  Preprocessor1_Model1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are the resampling estimates averaged over the individual replicates. To get the metrics for each resample, use the option <code>summarize = FALSE</code>.</p>
<p>Notice how much more realistic the performance estimates are than the resubstitution estimates from Section @ref(resampling-resubstition)!</p>
<p>To obtain the assessment set predictions:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">assess_res</span> <span class="op">&lt;-</span> <span class="fu">collect_predictions</span><span class="op">(</span><span class="va">rf_res</span><span class="op">)</span></span>
<span><span class="va">assess_res</span></span>
<span><span class="co">## # A tibble: 2,342 × 5</span></span>
<span><span class="co">##   id     .pred  .row Sale_Price .config             </span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">## 1 Fold01  5.10    10       5.09 Preprocessor1_Model1</span></span>
<span><span class="co">## 2 Fold01  4.92    27       4.90 Preprocessor1_Model1</span></span>
<span><span class="co">## 3 Fold01  5.21    47       5.08 Preprocessor1_Model1</span></span>
<span><span class="co">## 4 Fold01  5.13    52       5.10 Preprocessor1_Model1</span></span>
<span><span class="co">## 5 Fold01  5.13    59       5.10 Preprocessor1_Model1</span></span>
<span><span class="co">## 6 Fold01  5.13    63       5.11 Preprocessor1_Model1</span></span>
<span><span class="co">## # ℹ 2,336 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The prediction column names follow the conventions discussed for <span class="pkg">parsnip</span> models in Chapter @ref(models), for consistency and ease of use. The observed outcome column always uses the original column name from the source data. The <code>.row</code> column is an integer that matches the row of the original training set so that these results can be properly arranged and joined with the original data.</p>
<div class="rmdnote">
<p>For some resampling methods, such as the bootstrap or repeated cross-validation, there will be multiple predictions per row of the original training set. To obtain summarized values (averages of the replicate predictions) use <code>collect_predictions(object, summarize = TRUE)</code>.</p>
</div>
<p>Since this analysis used 10-fold cross-validation, there is one unique prediction for each training set sample. These data can generate helpful plots of the model to understand where it potentially failed. For example, Figure @ref(fig:ames-resampled-performance) compares the observed and held-out predicted values (analogous to Figure @ref(fig:ames-performance-plot)):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">assess_res</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Sale_Price</span>, y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_obs_pred</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Predicted"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/ames-resampled-performance-1.png" class="img-fluid figure-img" alt="Scatter plots of out-of-sample observed versus predicted values for an Ames regression model. Both axes using log-10 units. The model shows good concordance with two outlying data points that are significantly over-predicted." width="480"></p>
<figcaption class="figure-caption">Out-of-sample observed versus predicted values for an Ames regression model, using log-10 units on both axes</figcaption></figure>
</div>
</div>
</div>
<p>There are two houses in the training set with a low observed sale price that are significantly overpredicted by the model. Which houses are these? Let’s find out from the <code>assess_res</code> result:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">over_predicted</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">assess_res</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>residual <span class="op">=</span> <span class="va">Sale_Price</span> <span class="op">-</span> <span class="va">.pred</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">residual</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">over_predicted</span></span>
<span><span class="co">## # A tibble: 2 × 6</span></span>
<span><span class="co">##   id     .pred  .row Sale_Price .config              residual</span></span>
<span><span class="co">##   &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;                   &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Fold09  4.96    32       4.11 Preprocessor1_Model1   -0.858</span></span>
<span><span class="co">## 2 Fold08  4.93   317       4.12 Preprocessor1_Model1   -0.816</span></span>
<span></span>
<span><span class="va">ames_train</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="va">over_predicted</span><span class="op">$</span><span class="va">.row</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Gr_Liv_Area</span>, <span class="va">Neighborhood</span>, <span class="va">Year_Built</span>, <span class="va">Bedroom_AbvGr</span>, <span class="va">Full_Bath</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 5</span></span>
<span><span class="co">##   Gr_Liv_Area Neighborhood           Year_Built Bedroom_AbvGr Full_Bath</span></span>
<span><span class="co">##         &lt;int&gt; &lt;fct&gt;                       &lt;int&gt;         &lt;int&gt;     &lt;int&gt;</span></span>
<span><span class="co">## 1         832 Old_Town                     1923             2         1</span></span>
<span><span class="co">## 2         733 Iowa_DOT_and_Rail_Road       1952             2         1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Identifying examples like these with especially poor performance can help us follow up and investigate why these specific predictions are so poor.</p>
<p>Let’s move back to the homes overall. How can we use a validation set instead of cross-validation? From our previous <span class="pkg">rsample</span> object:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">val_res</span> <span class="op">&lt;-</span> <span class="va">rf_wflow</span> <span class="op">%&gt;%</span> <span class="fu">fit_resamples</span><span class="op">(</span>resamples <span class="op">=</span> <span class="va">val_set</span><span class="op">)</span></span>
<span><span class="co">## Warning in `[.tbl_df`(x, is.finite(x &lt;- as.numeric(x))): NAs introducidos por</span></span>
<span><span class="co">## coerción</span></span>
<span><span class="va">val_res</span></span>
<span><span class="co">## # Resampling results</span></span>
<span><span class="co">## #  </span></span>
<span><span class="co">## # A tibble: 1 × 4</span></span>
<span><span class="co">##   splits             id         .metrics         .notes          </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;      &lt;list&gt;           &lt;list&gt;          </span></span>
<span><span class="co">## 1 &lt;split [1758/586]&gt; validation &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt;</span></span>
<span></span>
<span><span class="fu">collect_metrics</span><span class="op">(</span><span class="va">val_res</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 6</span></span>
<span><span class="co">##   .metric .estimator   mean     n std_err .config             </span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               </span></span>
<span><span class="co">## 1 rmse    standard   0.0727     1      NA Preprocessor1_Model1</span></span>
<span><span class="co">## 2 rsq     standard   0.823      1      NA Preprocessor1_Model1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These results are also much closer to the test set results than the resubstitution estimates of performance.</p>
<div class="rmdnote">
<p>In these analyses, the resampling results are very close to the test set results. The two types of estimates tend to be well correlated. However, this could be from random chance. A seed value of <code>55</code> fixed the random numbers before creating the resamples. Try changing this value and re-running the analyses to investigate whether the resampled estimates match the test set results as well.</p>
</div>
</section><section id="parallel" class="level2" data-number="10.4"><h2 data-number="10.4" class="anchored" data-anchor-id="parallel">
<span class="header-section-number">10.4</span> Parallel Processing</h2>
<p>The models created during resampling are independent of one another. Computations of this kind are sometimes called <em>embarrassingly parallel</em>; each model could be fit simultaneously without issues.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> The <span class="pkg">tune</span> package uses the <a href="https://CRAN.R-project.org/package=foreach"><span class="pkg">foreach</span></a> package to facilitate parallel computations. These computations could be split across processors on the same computer or across different computers, depending on the chosen technology.</p>
<p>For computations conducted on a single computer, the number of possible worker processes is determined by the <span class="pkg">parallel</span> package:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># The number of physical cores in the hardware:</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## [1] 2</span></span>
<span></span>
<span><span class="co"># The number of possible independent processes that can </span></span>
<span><span class="co"># be simultaneously used:  </span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## [1] 4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The difference between these two values is related to the computer’s processor. For example, most Intel processors use hyperthreading, which creates two virtual cores for each physical core. While these extra resources can improve performance, most of the speed-ups produced by parallel processing occur when processing uses fewer than the number of physical cores.</p>
<p>For <code>fit_resamples()</code> and other functions in <span class="pkg">tune</span>, parallel processing occurs when the user registers a parallel backend package. These R packages define how to execute parallel processing. On Unix and macOS operating systems, one method of splitting computations is by forking threads. To enable this, load the <span class="pkg">doMC</span> package and register the number of parallel cores with <span class="pkg">foreach</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Unix and macOS only</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doMC</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doMC/man/registerDoMC.html">registerDoMC</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now run fit_resamples()...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This instructs <code>fit_resamples()</code> to run half of the computations on each of two cores. To reset the computations to sequential processing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/registerDoSEQ.html">registerDoSEQ</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Alternatively, a different approach to parallelizing computations uses network sockets. The <span class="pkg">doParallel</span> package enables this method (usable by all operating systems):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># All operating systems</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel">doParallel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a cluster object and then register: </span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makePSOCKcluster</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now run fit_resamples()`...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another R package that facilitates parallel processing is the <a href="https://future.futureverse.org/"><span class="pkg">future</span></a> package. Like <span class="pkg">foreach</span>, it provides a framework for parallelism. This package is used in conjunction with <span class="pkg">foreach</span> via the <span class="pkg">doFuture</span> package.</p>
<div class="rmdnote">
<p>The R packages with parallel backends for <span class="pkg">foreach</span> start with the prefix <code>"do"</code>.</p>
</div>
<p>Parallel processing with the <span class="pkg">tune</span> package tends to provide linear speed-ups for the first few cores. This means that, with two cores, the computations are twice as fast. Depending on the data and model type, the linear speed-up deteriorates after four to five cores. Using more cores will still reduce the time it takes to complete the task; there are just diminishing returns for the additional cores.</p>
<p>Let’s wrap up with one final note about parallelism. For each of these technologies, the memory requirements multiply for each additional core used. For example, if the current data set is 2 GB in memory and three cores are used, the total memory requirement is 8 GB (2 for each worker process plus the original). Using too many cores might cause the computations (and the computer) to slow considerably.</p>
</section><section id="extract" class="level2" data-number="10.5"><h2 data-number="10.5" class="anchored" data-anchor-id="extract">
<span class="header-section-number">10.5</span> Saving the Resampled Objects</h2>
<p>The models created during resampling are not retained. These models are trained for the purpose of evaluating performance, and we typically do not need them after we have computed performance statistics. If a particular modeling approach does turn out to be the best option for our data set, then the best choice is to fit again to the whole training set so the model parameters can be estimated with more data.</p>
<p>While these models created during resampling are not preserved, there is a method for keeping them or some of their components. The <code>extract</code> option of <code>control_resamples()</code> specifies a function that takes a single argument; we’ll use <code>x</code>. When executed, <code>x</code> results in a fitted workflow object, regardless of whether you provided <code>fit_resamples()</code> with a workflow. Recall that the <span class="pkg">workflows</span> package has functions that can pull the different components of the objects (e.g., the model, recipe, etc.).</p>
<p>Let’s fit a linear regression model using the recipe we developed in Chapter @ref(recipes):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ames_rec</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Neighborhood</span> <span class="op">+</span> <span class="va">Gr_Liv_Area</span> <span class="op">+</span> <span class="va">Year_Built</span> <span class="op">+</span> <span class="va">Bldg_Type</span> <span class="op">+</span> </span>
<span>           <span class="va">Latitude</span> <span class="op">+</span> <span class="va">Longitude</span>, data <span class="op">=</span> <span class="va">ames_train</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_other</span><span class="op">(</span><span class="va">Neighborhood</span>, threshold <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_interact</span><span class="op">(</span> <span class="op">~</span> <span class="va">Gr_Liv_Area</span><span class="op">:</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"Bldg_Type_"</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">Latitude</span>, <span class="va">Longitude</span>, deg_free <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span> <span class="op">&lt;-</span>  </span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">ames_rec</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="va">lm_wflow</span> <span class="op">%&gt;%</span> <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">ames_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select the recipe: </span></span>
<span><span class="fu">extract_recipe</span><span class="op">(</span><span class="va">lm_fit</span>, estimated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Recipe ───────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Inputs</span></span>
<span><span class="co">## Number of variables by role</span></span>
<span><span class="co">## outcome:   1</span></span>
<span><span class="co">## predictor: 6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Training information</span></span>
<span><span class="co">## Training data contained 2342 data points and no incomplete rows.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ── Operations</span></span>
<span><span class="co">## • Collapsing factor levels for: Neighborhood | Trained</span></span>
<span><span class="co">## • Dummy variables from: Neighborhood, Bldg_Type | Trained</span></span>
<span><span class="co">## • Interactions with: Gr_Liv_Area:(Bldg_Type_TwoFmCon + Bldg_Type_Duplex +</span></span>
<span><span class="co">##   Bldg_Type_Twnhs + Bldg_Type_TwnhsE) | Trained</span></span>
<span><span class="co">## • Natural splines on: Latitude, Longitude | Trained</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can save the linear model coefficients for a fitted model object from a workflow:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">tidy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Test it using: </span></span>
<span><span class="co"># get_model(lm_fit)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s apply this function to the ten resampled fits. The results of the extraction function is wrapped in a list object and returned in a tibble:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu">control_resamples</span><span class="op">(</span>extract <span class="op">=</span> <span class="va">get_model</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_res</span> <span class="op">&lt;-</span> <span class="va">lm_wflow</span> <span class="op">%&gt;%</span>  <span class="fu">fit_resamples</span><span class="op">(</span>resamples <span class="op">=</span> <span class="va">ames_folds</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span></span>
<span><span class="va">lm_res</span></span>
<span><span class="co">## # Resampling results</span></span>
<span><span class="co">## # 10-fold cross-validation </span></span>
<span><span class="co">## # A tibble: 10 × 5</span></span>
<span><span class="co">##   splits             id     .metrics         .notes           .extracts       </span></span>
<span><span class="co">##   &lt;list&gt;             &lt;chr&gt;  &lt;list&gt;           &lt;list&gt;           &lt;list&gt;          </span></span>
<span><span class="co">## 1 &lt;split [2107/235]&gt; Fold01 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## 2 &lt;split [2107/235]&gt; Fold02 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## 3 &lt;split [2108/234]&gt; Fold03 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## 4 &lt;split [2108/234]&gt; Fold04 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## 5 &lt;split [2108/234]&gt; Fold05 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## 6 &lt;split [2108/234]&gt; Fold06 &lt;tibble [2 × 4]&gt; &lt;tibble [0 × 3]&gt; &lt;tibble [1 × 2]&gt;</span></span>
<span><span class="co">## # ℹ 4 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now there is a <code>.extracts</code> column with nested tibbles. What do these contain? Let’s find out by subsetting.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_res</span><span class="op">$</span><span class="va">.extracts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## # A tibble: 1 × 2</span></span>
<span><span class="co">##   .extracts         .config             </span></span>
<span><span class="co">##   &lt;list&gt;            &lt;chr&gt;               </span></span>
<span><span class="co">## 1 &lt;tibble [73 × 5]&gt; Preprocessor1_Model1</span></span>
<span></span>
<span><span class="co"># To get the results</span></span>
<span><span class="va">lm_res</span><span class="op">$</span><span class="va">.extracts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">## [[1]]</span></span>
<span><span class="co">## # A tibble: 73 × 5</span></span>
<span><span class="co">##   term                        estimate  std.error statistic   p.value</span></span>
<span><span class="co">##   &lt;chr&gt;                          &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 (Intercept)                 1.48     0.320         4.62   4.11e-  6</span></span>
<span><span class="co">## 2 Gr_Liv_Area                 0.000158 0.00000476   33.2    9.72e-194</span></span>
<span><span class="co">## 3 Year_Built                  0.00180  0.000149     12.1    1.57e- 32</span></span>
<span><span class="co">## 4 Neighborhood_College_Creek -0.00163  0.0373       -0.0438 9.65e-  1</span></span>
<span><span class="co">## 5 Neighborhood_Old_Town      -0.0757   0.0138       -5.47   4.92e-  8</span></span>
<span><span class="co">## 6 Neighborhood_Edwards       -0.109    0.0310       -3.53   4.21e-  4</span></span>
<span><span class="co">## # ℹ 67 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This might appear to be a convoluted method for saving the model results. However, <code>extract</code> is flexible and does not assume that the user will only save a single tibble per resample. For example, the <code>tidy()</code> method might be run on the recipe as well as the model. In this case, a list of two tibbles will be returned.</p>
<p>For our more simple example, all of the results can be flattened and collected using:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">all_coef</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span><span class="op">(</span><span class="va">lm_res</span><span class="op">$</span><span class="va">.extracts</span>, <span class="op">~</span> <span class="va">.x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Show the replicates for a single predictor:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">all_coef</span>, <span class="va">term</span> <span class="op">==</span> <span class="st">"Year_Built"</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 10 × 5</span></span>
<span><span class="co">##   term       estimate std.error statistic  p.value</span></span>
<span><span class="co">##   &lt;chr&gt;         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Year_Built  0.00180  0.000149      12.1 1.57e-32</span></span>
<span><span class="co">## 2 Year_Built  0.00180  0.000151      12.0 6.45e-32</span></span>
<span><span class="co">## 3 Year_Built  0.00185  0.000150      12.3 1.00e-33</span></span>
<span><span class="co">## 4 Year_Built  0.00183  0.000147      12.5 1.90e-34</span></span>
<span><span class="co">## 5 Year_Built  0.00184  0.000150      12.2 2.47e-33</span></span>
<span><span class="co">## 6 Year_Built  0.00180  0.000150      12.0 3.35e-32</span></span>
<span><span class="co">## # ℹ 4 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Chapters @ref(grid-search) and @ref(iterative-search) discuss a suite of functions for tuning models. Their interfaces are similar to <code>fit_resamples()</code> and many of the features described here apply to those functions.</p>
</section><section id="resampling-summary" class="level2" data-number="10.6"><h2 data-number="10.6" class="anchored" data-anchor-id="resampling-summary">
<span class="header-section-number">10.6</span> Chapter Summary</h2>
<p>This chapter describes one of the fundamental tools of data analysis, the ability to measure the performance and variation in model results. Resampling enables us to determine how well the model works without using the test set.</p>
<p>An important function from the <span class="pkg">tune</span> package, called <code>fit_resamples()</code>, was introduced. The interface for this function is also used in future chapters that describe model tuning tools.</p>
<p>The data analysis code, so far, for the Ames data is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ames</span><span class="op">)</span></span>
<span><span class="va">ames</span> <span class="op">&lt;-</span> <span class="fu">mutate</span><span class="op">(</span><span class="va">ames</span>, Sale_Price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">Sale_Price</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">502</span><span class="op">)</span></span>
<span><span class="va">ames_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">ames</span>, prop <span class="op">=</span> <span class="fl">0.80</span>, strata <span class="op">=</span> <span class="va">Sale_Price</span><span class="op">)</span></span>
<span><span class="va">ames_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span><span class="va">ames_test</span>  <span class="op">&lt;-</span>  <span class="fu">testing</span><span class="op">(</span><span class="va">ames_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ames_rec</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Neighborhood</span> <span class="op">+</span> <span class="va">Gr_Liv_Area</span> <span class="op">+</span> <span class="va">Year_Built</span> <span class="op">+</span> <span class="va">Bldg_Type</span> <span class="op">+</span> </span>
<span>           <span class="va">Latitude</span> <span class="op">+</span> <span class="va">Longitude</span>, data <span class="op">=</span> <span class="va">ames_train</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_log</span><span class="op">(</span><span class="va">Gr_Liv_Area</span>, base <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_other</span><span class="op">(</span><span class="va">Neighborhood</span>, threshold <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_interact</span><span class="op">(</span> <span class="op">~</span> <span class="va">Gr_Liv_Area</span><span class="op">:</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"Bldg_Type_"</span><span class="op">)</span> <span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">Latitude</span>, <span class="va">Longitude</span>, deg_free <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_model</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lm_model</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">ames_rec</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">lm_wflow</span>, <span class="va">ames_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_model</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rand_forest</span><span class="op">(</span>trees <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_wflow</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_formula</span><span class="op">(</span></span>
<span>    <span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Neighborhood</span> <span class="op">+</span> <span class="va">Gr_Liv_Area</span> <span class="op">+</span> <span class="va">Year_Built</span> <span class="op">+</span> <span class="va">Bldg_Type</span> <span class="op">+</span> </span>
<span>      <span class="va">Latitude</span> <span class="op">+</span> <span class="va">Longitude</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">rf_model</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1001</span><span class="op">)</span></span>
<span><span class="va">ames_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">ames_train</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">keep_pred</span> <span class="op">&lt;-</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span>, save_workflow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1003</span><span class="op">)</span></span>
<span><span class="va">rf_res</span> <span class="op">&lt;-</span> <span class="va">rf_wflow</span> <span class="op">%&gt;%</span> <span class="fu">fit_resamples</span><span class="op">(</span>resamples <span class="op">=</span> <span class="va">ames_folds</span>, control <span class="op">=</span> <span class="va">keep_pred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-breiman2001random" class="csl-entry" role="listitem">
Breiman, L. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32.
</div>
<div id="ref-davison1997bootstrap" class="csl-entry" role="listitem">
Davison, A, and D Hinkley. 1997. <em>Bootstrap Methods and Their Application</em>. Vol. 1. Cambridge university press.
</div>
<div id="ref-hyndman2018forecasting" class="csl-entry" role="listitem">
Hyndman, R, and G Athanasopoulos. 2018. <em>Forecasting: Principles and Practice</em>. OTexts.
</div>
<div id="ref-fes" class="csl-entry" role="listitem">
Kuhn, M, and K Johnson. 2020. <em>Feature Engineering and Selection: A Practical Approach for Predictive Models</em>. CRC Press.
</div>
<div id="ref-parallel" class="csl-entry" role="listitem">
Schmidberger, M, M Morgan, D Eddelbuettel, H Yu, L Tierney, and U Mansmann. 2009. <span>“State of the Art in Parallel Computing with <span>R</span>.”</span> <em>Journal of Statistical Software</em> 31 (1): 1–27. <a href="https://www.jstatsoft.org/v031/i01">https://www.jstatsoft.org/v031/i01</a>.
</div>
<div id="ref-xu2001monte" class="csl-entry" role="listitem">
Xu, Q, and Y Liang. 2001. <span>“<span>Monte Carlo</span> Cross Validation.”</span> <em>Chemometrics and Intelligent Laboratory Systems</em> 56 (1): 1–11.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>See Section 1.2.5 of <span class="citation" data-cites="fes">Kuhn and Johnson (<a href="#ref-fes" role="doc-biblioref">2020</a>)</span> for a discussion: <a href="https://bookdown.org/max/FES/important-concepts.html#model-bias-and-variance" class="uri">https://bookdown.org/max/FES/important-concepts.html#model-bias-and-variance</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>It is possible for a linear model to nearly memorize the training set, like the random forest model did. In the <code>ames_rec</code> object, change the number of spline terms for <code>longitude</code> and <code>latitude</code> to a large number (say 1,000). This would produce a model fit with a very small resubstitution RMSE and a test set RMSE that is much larger.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See Section 3.4 of <span class="citation" data-cites="fes">Kuhn and Johnson (<a href="#ref-fes" role="doc-biblioref">2020</a>)</span> for a longer description of the results of changing <em>V</em>: <a href="https://bookdown.org/max/FES/resampling.html" class="uri">https://bookdown.org/max/FES/resampling.html</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>To see this for yourself, try executing <code>lobstr::obj_size(ames_folds)</code> and <code>lobstr::obj_size(ames_train)</code>. The size of the resample object is much less than ten times the size of the original data.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Some resampling methods require multiple <code>id</code> fields.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>For more details, see Section 3.4.6 of <span class="citation" data-cites="fes">Kuhn and Johnson (<a href="#ref-fes" role="doc-biblioref">2020</a>)</span>: <a href="https://bookdown.org/max/FES/resampling.html#resample-var-bias" class="uri">https://bookdown.org/max/FES/resampling.html#resample-var-bias</a>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>These are <em>approximate</em> standard errors. As will be discussed in the next chapter, there is a within-replicate correlation that is typical of resampled results. By ignoring this extra component of variation, the simple calculations shown in this plot are overestimates of the reduction in noise in the standard errors.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>In essence, a validation set can be considered a single iteration of Monte Carlo cross-validation.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p><span class="citation" data-cites="parallel">Schmidberger et al. (<a href="#ref-parallel" role="doc-biblioref">2009</a>)</span> gives a technical overview of these technologies.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./09-judging-model-effectiveness.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Judging Model Effectiveness</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./11-comparing-models.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing Models with Resampling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Modelado Ordenado con R fue escrito por Max Kuhn, y Julia Silge.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>