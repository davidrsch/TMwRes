<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Max Kuhn, y Julia Silge">
<title>Modelado Ordenado con R - 20&nbsp; Ensembles of Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./21-inferential-analysis.html" rel="next">
<link href="./19-when-should-you-trust-predictions.html" rel="prev">
<link href="./images/cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="site_libs/kePrint-0.0.1/kePrint.js"></script><link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="TMwR.css">
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./16-dimensionality-reduction.html">BEYOND THE BASICS</a></li><li class="breadcrumb-item"><a href="./20-ensemble-models.html"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modelado Ordenado con R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/davidrsch/TMwRes" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello World</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">INTRODUCTION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-software-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Software for modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A Tidyverse Primer</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-base-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Review of R Modeling Fundamentals</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">MODELING BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-ames.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Ames Housing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-data-spending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spending our Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-fitting-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Fitting Models with parsnip</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-the-model-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">A Model Workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-feature-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Feature Engineering with recipes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-judging-model-effectiveness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Judging Model Effectiveness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">TOOLS FOR CREATING EFFECTIVE MODELS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-comparing-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing Models with Resampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-tuning-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Tuning and the Dangers of Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-iterative-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Iterative Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-workflow-sets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Screening Many Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">BEYOND THE BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-dimensionality-reduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensionality Reduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-encoding-categorical-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Encoding Categorical Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-explaining-models-and-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-when-should-you-trust-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-ensemble-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-inferential-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Inferential Analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pre-proc-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Recommended Preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-data-stack" id="toc-sec-data-stack" class="nav-link active" data-scroll-target="#sec-data-stack"><span class="header-section-number">20.1</span> Creating the Training Set for Stacking</a></li>
  <li><a href="#sec-blend-predictions" id="toc-sec-blend-predictions" class="nav-link" data-scroll-target="#sec-blend-predictions"><span class="header-section-number">20.2</span> Blend the Predictions</a></li>
  <li><a href="#sec-fit-members" id="toc-sec-fit-members" class="nav-link" data-scroll-target="#sec-fit-members"><span class="header-section-number">20.3</span> Fit the Member Models</a></li>
  <li><a href="#test-set-results" id="toc-test-set-results" class="nav-link" data-scroll-target="#test-set-results"><span class="header-section-number">20.4</span> Test Set Results</a></li>
  <li><a href="#sec-ensembles-summary" id="toc-sec-ensembles-summary" class="nav-link" data-scroll-target="#sec-ensembles-summary"><span class="header-section-number">20.5</span> Chapter Summary</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/davidrsch/TMwRes/edit/main/20-ensemble-models.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/davidrsch/TMwRes/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-ensembles" class="quarto-section-identifier"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>A model ensemble, where the predictions of multiple single learners are aggregated to make one prediction, can produce a high-performance final model. The most popular methods for creating ensemble models are bagging <span class="citation" data-cites="breiman1996bagging">(<a href="references.html#ref-breiman1996bagging" role="doc-biblioref">Breiman 1996a</a>)</span>, random forest <span class="citation" data-cites="ho1995random breiman2001random">(<a href="references.html#ref-ho1995random" role="doc-biblioref">Ho 1995</a>; <a href="references.html#ref-breiman2001random" role="doc-biblioref">Breiman 2001</a>)</span>, and boosting <span class="citation" data-cites="freund1997decision">(<a href="references.html#ref-freund1997decision" role="doc-biblioref">Freund and Schapire 1997</a>)</span>. Each of these methods combines the predictions from multiple versions of the same type of model (e.g., classifications trees). However, one of the earliest methods for creating ensembles is <em>model stacking</em> <span class="citation" data-cites="wolpert1992stacked breiman1996stacked">(<a href="references.html#ref-wolpert1992stacked" role="doc-biblioref">Wolpert 1992</a>; <a href="references.html#ref-breiman1996stacked" role="doc-biblioref">Breiman 1996b</a>)</span>.</p>
<div class="rmdnote">
<p>Model stacking combines the predictions for multiple models of any type. For example, a logistic regression, classification tree, and support vector machine can be included in a stacking ensemble.</p>
</div>
<p>This chapter shows how to stack predictive models using the <span class="pkg">stacks</span> package. We’ll re-use the results from <a href="15-workflow-sets.html">Chapter&nbsp;<span>15</span></a> where multiple models were evaluated to predict the compressive strength of concrete mixtures.</p>
<p>The process of building a stacked ensemble is:</p>
<ol type="1">
<li>Assemble the training set of hold-out predictions (produced via resampling).</li>
<li>Create a model to blend these predictions.</li>
<li>For each member of the ensemble, fit the model on the original training set.</li>
</ol>
<p>In subsequent sections, we’ll describe this process. However, before proceeding, we’ll clarify some nomenclature for the variations of what “the model” can mean. This can quickly become an overloaded term when we are working on a complex modeling analysis! Let’s consider the multilayer perceptron (MLP) model (a.k.a. neural network) created in <a href="15-workflow-sets.html">Chapter&nbsp;<span>15</span></a>.</p>
<p>In general, we’ll talk about an MLP model as the <em>type</em> of model. Linear regression and support vector machines are other model types.</p>
<p>Tuning parameters are an important aspect of a model. Back in <a href="15-workflow-sets.html">Chapter&nbsp;<span>15</span></a>, the MLP model was tuned over 25 tuning parameter values. In the previous chapters, we’ve called these <em>candidate tuning parameter</em> values or <em>model configurations</em>. In literature on ensembling these have also been called the base models.</p>
<div class="rmdnote">
<p>We’ll use the term <em>candidate members</em> to describe the possible model configurations (of all model types) that might be included in the stacking ensemble.</p>
</div>
<p>This means that a stacking model can include different types of models (e.g., trees and neural networks) as well as different configurations of the same model (e.g., trees with different depths).</p>
<section id="sec-data-stack" class="level2" data-number="20.1"><h2 data-number="20.1" class="anchored" data-anchor-id="sec-data-stack">
<span class="header-section-number">20.1</span> Creating the Training Set for Stacking</h2>
<p>The first step for building a stacked ensemble relies on the assessment set predictions from a resampling scheme with multiple splits. For each data point in the training set, stacking requires an out-of-sample prediction of some sort. For regression models, this is the predicted outcome. For classification models, the predicted classes or probabilities are available for use, although the latter contains more information than the hard class predictions. For a set of models, a data set is assembled where rows are the training set samples and columns are the out-of-sample predictions from the set of multiple models.</p>
<p>Back in <a href="15-workflow-sets.html">Chapter&nbsp;<span>15</span></a>, we used five repeats of 10-fold cross-validation to resample the data. This resampling scheme generates five assessment set predictions for each training set sample. Multiple out-of-sample predictions can occur in several other resampling techniques (e.g., bootstrapping). For the purpose of stacking, any replicate predictions for a data point in the training set are averaged so that there is a single prediction per training set sample per candidate member.</p>
<div class="rmdnote">
<p>Simple validation sets can also be used with stacking since tidymodels considers this to be a single resample.</p>
</div>
<p>For the concrete example, the training set used for model stacking has columns for all of the candidate tuning parameter results. <a href="#tbl-ensemble-candidate-preds">Table&nbsp;<span>20.1</span></a> presents the first six rows and selected columns.</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/tbl-ensemble-candidate-preds_5bcca83b1787fdf6be68fb86b84eee20">
<div class="cell-output-display">
<div id="tbl-ensemble-candidate-preds" class="anchored">
<table class="table table-striped table-sm small" data-quarto-postprocess="true">
<caption>Table&nbsp;20.1: Predictions from candidate tuning parameter configurations.</caption>
<colgroup>
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th" style="text-align: center; empty-cells: hide; border-bottom: hidden;"></th>
<th colspan="7" data-quarto-table-cell-role="th" style="text-align: center; border-bottom: hidden; padding-bottom: 0; padding-left: 3px; padding-right: 3px;"><div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Ensemble Candidate Predictions
</div></th>
</tr>
<tr class="odd">
<th style="text-align: center;" data-quarto-table-cell-role="th">Sample #</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Bagged Tree</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">MARS 1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">MARS 2</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Cubist 1</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">...</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">Cubist 25</th>
<th style="text-align: center;" data-quarto-table-cell-role="th">...</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">25.18</td>
<td style="text-align: center;">17.92</td>
<td style="text-align: center;">17.15</td>
<td style="text-align: center;">17.79</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">17.82</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">5.18</td>
<td style="text-align: center;">-1.77</td>
<td style="text-align: center;">-0.73</td>
<td style="text-align: center;">2.83</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">3.87</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">9.71</td>
<td style="text-align: center;">7.26</td>
<td style="text-align: center;">5.91</td>
<td style="text-align: center;">6.31</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">8.60</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">25.21</td>
<td style="text-align: center;">20.93</td>
<td style="text-align: center;">21.52</td>
<td style="text-align: center;">23.72</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">21.61</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">6.33</td>
<td style="text-align: center;">1.53</td>
<td style="text-align: center;">0.15</td>
<td style="text-align: center;">3.60</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">4.57</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">7.88</td>
<td style="text-align: center;">4.88</td>
<td style="text-align: center;">1.74</td>
<td style="text-align: center;">7.69</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">7.55</td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
</div>


</div>
</div>
<p>There is a single column for the bagged tree model since it has no tuning parameters. Also, recall that MARS was tuned over a single parameter (the product degree) with two possible configurations, so this model is represented by two columns. Most of the other models have 25 corresponding columns, as shown for Cubist in this example.</p>
<div class="rmdwarning">
<p>For classification models, the candidate prediction columns would be predicted class probabilities. Since these columns add to one for each model, the probabilities for one of the classes can be left out.</p>
</div>
<p>To summarize where we are so far, the first step to stacking is to assemble the assessment set predictions for the training set from each candidate model. We can use these assessment set predictions to move forward and build a stacked ensemble.</p>
<p>To start ensembling with the <span class="pkg">stacks</span> package, create an empty data stack using the <code><a href="https://stacks.tidymodels.org/reference/stacks.html">stacks()</a></code> function and then add candidate models. Recall that we used workflow sets to fit a wide variety of models to these data. We’ll use the racing results:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-race_b69b3c5476a1ceb17a67e7f46d359df6">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">race_results</span></span>
<span><span class="co">## # A workflow set/tibble: 12 × 4</span></span>
<span><span class="co">##   wflow_id    info             option    result   </span></span>
<span><span class="co">##   &lt;chr&gt;       &lt;list&gt;           &lt;list&gt;    &lt;list&gt;   </span></span>
<span><span class="co">## 1 MARS        &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;race[+]&gt;</span></span>
<span><span class="co">## 2 CART        &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;race[+]&gt;</span></span>
<span><span class="co">## 3 CART_bagged &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;rsmp[+]&gt;</span></span>
<span><span class="co">## 4 RF          &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;race[+]&gt;</span></span>
<span><span class="co">## 5 boosting    &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;race[+]&gt;</span></span>
<span><span class="co">## 6 Cubist      &lt;tibble [1 × 4]&gt; &lt;opts[3]&gt; &lt;race[+]&gt;</span></span>
<span><span class="co">## # ℹ 6 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, our syntax is:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-data-stack_954077dca446878af024ec52e09fda68">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stacks.tidymodels.org/">stacks</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tidymodels.tidymodels.org/reference/tidymodels_prefer.html">tidymodels_prefer</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">concrete_stack</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://stacks.tidymodels.org/reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">race_results</span><span class="op">)</span></span>
<span></span>
<span><span class="va">concrete_stack</span></span>
<span><span class="co">## # A data stack with 12 model definitions and 18 candidate members:</span></span>
<span><span class="co">## #   MARS: 1 model configuration</span></span>
<span><span class="co">## #   CART: 1 model configuration</span></span>
<span><span class="co">## #   CART_bagged: 1 model configuration</span></span>
<span><span class="co">## #   RF: 1 model configuration</span></span>
<span><span class="co">## #   boosting: 1 model configuration</span></span>
<span><span class="co">## #   Cubist: 1 model configuration</span></span>
<span><span class="co">## #   SVM_radial: 1 model configuration</span></span>
<span><span class="co">## #   SVM_poly: 1 model configuration</span></span>
<span><span class="co">## #   KNN: 3 model configurations</span></span>
<span><span class="co">## #   neural_network: 1 model configuration</span></span>
<span><span class="co">## #   full_quad_linear_reg: 5 model configurations</span></span>
<span><span class="co">## #   full_quad_KNN: 1 model configuration</span></span>
<span><span class="co">## # Outcome: compressive_strength (numeric)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that racing methods (<a href="13-grid-search.html#sec-racing"><span>Section&nbsp;13.5.5</span></a>) are more efficient since they might not evaluate all configurations on all resamples. Stacking requires that all candidate members have the complete set of resamples. <code><a href="https://stacks.tidymodels.org/reference/add_candidates.html">add_candidates()</a></code> includes only the model configurations that have complete results.</p>
<div class="rmdnote">
<p>Why use the racing results instead of the full set of candidate models contained in <code>grid_results</code>? Either can be used. We found better performance for these data using the racing results. This might be due to the racing method pre-selecting the best model(s) from the larger grid.</p>
</div>
<p>If we had not used the <span class="pkg">workflowsets</span> package, objects from the <span class="pkg">tune</span> and <span class="pkg">finetune</span> could also be passed to <code><a href="https://stacks.tidymodels.org/reference/add_candidates.html">add_candidates()</a></code>. This can include both grid and iterative search objects.</p>
</section><section id="sec-blend-predictions" class="level2" data-number="20.2"><h2 data-number="20.2" class="anchored" data-anchor-id="sec-blend-predictions">
<span class="header-section-number">20.2</span> Blend the Predictions</h2>
<p>The training set predictions and the corresponding observed outcome data are used to create a <em>meta-learning model</em> where the assessment set predictions are the predictors of the observed outcome data. Meta-learning can be accomplished using any model. The most commonly used model is a regularized generalized linear model, which encompasses linear, logistic, and multinomial models. Specifically, regularization via the lasso penalty <span class="citation" data-cites="lasso">(<a href="references.html#ref-lasso" role="doc-biblioref">Tibshirani 1996</a>)</span>, which uses shrinkage to pull points toward a central value, has several advantages:</p>
<ul>
<li>Using the lasso penalty can remove candidates (and sometimes whole model types) from the ensemble.</li>
<li>The correlation between ensemble candidates tends to be very high, and regularization helps alleviate this issue.</li>
</ul>
<p><span class="citation" data-cites="breiman1996stacked">Breiman (<a href="references.html#ref-breiman1996stacked" role="doc-biblioref">1996b</a>)</span> also suggested that, when a linear model is used to blend the predictions, it might be helpful to constrain the blending coefficients to be nonnegative. We have generally found this to be good advice and it is the default for the <span class="pkg">stacks</span> package (but it can be changed via an optional argument).</p>
<p>Since our outcome is numeric, linear regression is used for the metamodel. Fitting the metamodel is as straightforward as using:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-initial-blend_7e4d13223ca59ac9aaca0c8b70961179">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2001</span><span class="op">)</span></span>
<span><span class="va">ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stacks.tidymodels.org/reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="va">concrete_stack</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This evaluates the meta-learning model over a predefined grid of lasso penalty values and uses an internal resampling method to determine the best value. The <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method, shown in <a href="#fig-stacking-autoplot">Figure&nbsp;<span>20.1</span></a>, helps us understand if the default penalization method was sufficient:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-initial-blend-plot_c61ba53afcecd4bfab9dabb8e719c8aa">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">ens</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/fig-stacking-autoplot_a6e00aa7a3e85a72f6c8bfe94b805921">
<div class="cell-output-display">
<div id="fig-stacking-autoplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="20-ensemble-models_files/figure-html/fig-stacking-autoplot-1.png" class="img-fluid figure-img" alt="The results of using the `autoplot()` method on the blended stacks object." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;20.1: Results of using the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method on the blended stacks object</figcaption></figure>
</div>
</div>
</div>
<p>The top panel of <a href="#fig-stacking-autoplot">Figure&nbsp;<span>20.1</span></a> shows the average number of candidate ensemble members retained by the meta-learning model. We can see that the number of members is fairly constant and, as it increases, the RMSE also increases.</p>
<p>The default range may not have served us well here. To evaluate the meta-learning model with larger penalties, let’s pass an additional option:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-second-blend_43416a686b925c7a6cdb1a1c587e5c85">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2002</span><span class="op">)</span></span>
<span><span class="va">ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stacks.tidymodels.org/reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="va">concrete_stack</span>, penalty <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">0.5</span>, length <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, in <a href="#fig-stacking-autoplot-redo">Figure&nbsp;<span>20.2</span></a>, we see a range where the ensemble model becomes worse than with our first blend (but not by much). The <span class="math inline">\(R^2\)</span> values increase with more members and larger penalties.</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-autoplot-calc_ee9a2e8c837e8ae68ed79b26bc84fbd9">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">ens</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/fig-stacking-autoplot-redo_1e4702636839e47adc0cb7296e9c385f">
<div class="cell-output-display">
<div id="fig-stacking-autoplot-redo" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="20-ensemble-models_files/figure-html/fig-stacking-autoplot-redo-1.png" class="img-fluid figure-img" alt="The results of using the `autoplot()` method on the updated blended stacks object." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;20.2: The results of using the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method on the updated blended stacks object</figcaption></figure>
</div>
</div>
</div>
<p>When blending predictions using a regression model, it is common to constrain the blending parameters to be nonnegative. For these data, this constraint has the effect of eliminating many of the potential ensemble members; even at fairly low penalties, the ensemble is limited to a fraction of the original eighteen.</p>
<p>The penalty value associated with the smallest RMSE was 0.01. Printing the object shows the details of the meta-learning model:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-second-blend-print_25fa89ad9d8ff9c218f9a038e15a3ac3">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ens</span></span>
<span><span class="co">## ── A stacked ensemble model ─────────────────────────────────────</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Out of 18 possible candidate members, the ensemble retained 5.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Penalty: 0.01.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Mixture: 1.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The 5 highest weighted members are:</span></span>
<span><span class="co">## # A tibble: 5 × 3</span></span>
<span><span class="co">##   member                    type           weight</span></span>
<span><span class="co">##   &lt;chr&gt;                     &lt;chr&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">## 1 boosting_1_16             boost_tree    0.712  </span></span>
<span><span class="co">## 2 neural_network_1_17       mlp           0.208  </span></span>
<span><span class="co">## 3 Cubist_1_25               cubist_rules  0.0759 </span></span>
<span><span class="co">## 4 full_quad_linear_reg_1_16 linear_reg    0.0161 </span></span>
<span><span class="co">## 5 CART_1_05                 decision_tree 0.00476</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Members have not yet been fitted with `fit_members()`.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The regularized linear regression meta-learning model contained five blending coefficients across five types of models. The <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method can be used again to show the contributions of each model type, to produce <a href="#fig-blending-weights">Figure&nbsp;<span>20.3</span></a>.</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-blending-weights_e28c16cf638ce2f666e2f932e29c9772">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">ens</span>, <span class="st">"weights"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">weight</span> <span class="op">+</span> <span class="fl">0.01</span>, label <span class="op">=</span> <span class="va">model</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">lims</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/fig-blending-weights_d300184506b672e799d76fcd9348557d">
<div class="cell-output-display">
<div id="fig-blending-weights" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="20-ensemble-models_files/figure-html/fig-blending-weights-1.png" class="img-fluid figure-img" alt="blending_alt" width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;20.3: Blending coefficients for the stacking ensemble</figcaption></figure>
</div>
</div>
</div>
<p>The boosted tree and neural network models have the largest contributions to the ensemble. For this ensemble, the outcome is predicted with the equation:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-equation_30060f5a9dc4938afe50c2c42a688fc0">
<p><span class="math display">\[\begin{align}
\text{ensemble prediction} &amp;=-0.62 \\
    +&amp;0.71 \times \text{boost tree prediction} \notag \\
    +&amp;0.21 \times \text{mlp prediction} \notag \\
    +&amp;0.076 \times \text{cubist rules prediction} \notag \\
    +&amp;0.016 \times \text{linear reg prediction} \notag \\
    +&amp;0.0048 \times \text{decision tree prediction} \notag
\end{align}\]</span></p>
</div>
<p>where the predictors in the equation are the predicted compressive strength values from those models.</p>
</section><section id="sec-fit-members" class="level2" data-number="20.3"><h2 data-number="20.3" class="anchored" data-anchor-id="sec-fit-members">
<span class="header-section-number">20.3</span> Fit the Member Models</h2>
<p>The ensemble contains five candidate members, and we now know how their predictions can be blended into a final prediction for the ensemble. However, these individual model fits have not yet been created. To be able to use the stacking model, five additional model fits are required. These use the entire training set with the original predictors.</p>
<p>The five models to be fit are:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-show-members_e58167a95049fa46aef82a237853de5d">
<ul>
<li><p>boosting: number of trees = 1800, minimal node size = 25, tree depth = 4, learning rate = 0.109, minimum loss reduction = 9.84e-10, and proportion of observations sampled = 0.85</p></li>
<li><p>Cubist: number of committees = 98 and number of nearest neighbors = 2</p></li>
<li><p>CART: cost-complexity parameter = 5e-08 and minimal node size = 3</p></li>
<li><p>linear regression (quadratic features): amount of regularization = 6.28e-09 and proportion of lasso penalty = 0.636</p></li>
<li><p>neural network: number of hidden units = 26, amount of regularization = 0.0149, and number of epochs = 203</p></li>
</ul>
</div>
<p>The <span class="pkg">stacks</span> package has a function, <code><a href="https://stacks.tidymodels.org/reference/fit_members.html">fit_members()</a></code>, that trains and returns these models:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-fit-members_2714c93d9fab59933c8d181256c0446e">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stacks.tidymodels.org/reference/fit_members.html">fit_members</a></span><span class="op">(</span><span class="va">ens</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This updates the stacking object with the fitted workflow objects for each member. At this point, the stacking model can be used for prediction.</p>
</section><section id="test-set-results" class="level2" data-number="20.4"><h2 data-number="20.4" class="anchored" data-anchor-id="test-set-results">
<span class="header-section-number">20.4</span> Test Set Results</h2>
<p>Since the blending process used resampling, we can estimate that the ensemble with five members had an estimated RMSE of 4.09. Recall from <a href="15-workflow-sets.html">Chapter&nbsp;<span>15</span></a> that the best boosted tree had a test set RMSE of 3.46. How will the ensemble model compare on the test set? We can <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> to find out:</p>
<div class="cell" data-layout-align="center" data-hash="20-ensemble-models_cache/html/ensembles-test-set_7669246b644b1f3439327f86657dab75">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reg_metrics</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">rsq</span><span class="op">)</span></span>
<span><span class="va">ens_test_pred</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">ens</span>, <span class="va">concrete_test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="va">concrete_test</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ens_test_pred</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">reg_metrics</span><span class="op">(</span><span class="va">compressive_strength</span>, <span class="va">.pred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 2 × 3</span></span>
<span><span class="co">##   .metric .estimator .estimate</span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">## 1 rmse    standard       3.37 </span></span>
<span><span class="co">## 2 rsq     standard       0.956</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is moderately better than our best single model. It is fairly common for stacking to produce incremental benefits when compared to the best single model.</p>
</section><section id="sec-ensembles-summary" class="level2" data-number="20.5"><h2 data-number="20.5" class="anchored" data-anchor-id="sec-ensembles-summary">
<span class="header-section-number">20.5</span> Chapter Summary</h2>
<p>This chapter demonstrated how to combine different models into an ensemble for better predictive performance. The process of creating the ensemble can automatically eliminate candidate models to find a small subset that improves performance. The <span class="pkg">stacks</span> package has a fluent interface for combining resampling and tuning results into a meta-model.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-breiman1996bagging" class="csl-entry" role="listitem">
Breiman, L. 1996a. <span>“Bagging Predictors.”</span> <em>Machine Learning</em> 24 (2): 123–40.
</div>
<div id="ref-breiman1996stacked" class="csl-entry" role="listitem">
———. 1996b. <span>“Stacked Regressions.”</span> <em>Machine Learning</em> 24 (1): 49–64.
</div>
<div id="ref-breiman2001random" class="csl-entry" role="listitem">
———. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32.
</div>
<div id="ref-freund1997decision" class="csl-entry" role="listitem">
Freund, Y, and R Schapire. 1997. <span>“A Decision-Theoretic Generalization of on-Line Learning and an Application to Boosting.”</span> <em>Journal of Computer and System Sciences</em> 55 (1): 119–39.
</div>
<div id="ref-ho1995random" class="csl-entry" role="listitem">
Ho, T. 1995. <span>“Random Decision Forests.”</span> In <em>Proceedings of 3rd International Conference on Document Analysis and Recognition</em>, 1:278–82. IEEE.
</div>
<div id="ref-lasso" class="csl-entry" role="listitem">
Tibshirani, Robert. 1996. <span>“Regression Shrinkage and Selection via the Lasso.”</span> <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 58 (1): 267–88. <a href="http://www.jstor.org/stable/2346178">http://www.jstor.org/stable/2346178</a>.
</div>
<div id="ref-wolpert1992stacked" class="csl-entry" role="listitem">
Wolpert, D. 1992. <span>“Stacked Generalization.”</span> <em>Neural Networks</em> 5 (2): 241–59.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./19-when-should-you-trust-predictions.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./21-inferential-analysis.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Inferential Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Modelado Ordenado con R fue escrito por Max Kuhn, y Julia Silge.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>