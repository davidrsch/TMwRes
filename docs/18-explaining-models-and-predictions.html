<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Max Kuhn, y Julia Silge">
<title>Modelado Ordenado con R - 18&nbsp; Explaining Models and Predictions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./19-when-should-you-trust-predictions.html" rel="next">
<link href="./17-encoding-categorical-data.html" rel="prev">
<link href="./images/cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="TMwR.css">
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./16-dimensionality-reduction.html">BEYOND THE BASICS</a></li><li class="breadcrumb-item"><a href="./18-explaining-models-and-predictions.html"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modelado Ordenado con R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/davidrsch/TMwRes" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello World</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">INTRODUCTION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-software-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Software for modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A Tidyverse Primer</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-base-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Review of R Modeling Fundamentals</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">MODELING BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-ames.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Ames Housing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-data-spending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spending our Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-fitting-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Fitting Models with parsnip</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-the-model-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">A Model Workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-feature-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Feature Engineering with recipes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-judging-model-effectiveness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Judging Model Effectiveness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">TOOLS FOR CREATING EFFECTIVE MODELS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-comparing-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing Models with Resampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-tuning-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Tuning and the Dangers of Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-iterative-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Iterative Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-workflow-sets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Screening Many Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">BEYOND THE BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-dimensionality-reduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensionality Reduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-encoding-categorical-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Encoding Categorical Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-explaining-models-and-predictions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-when-should-you-trust-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-ensemble-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-inferential-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Inferential Analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pre-proc-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Recommended Preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#software-for-model-explanations" id="toc-software-for-model-explanations" class="nav-link active" data-scroll-target="#software-for-model-explanations"><span class="header-section-number">18.1</span> Software for Model Explanations</a></li>
  <li><a href="#local-explanations" id="toc-local-explanations" class="nav-link" data-scroll-target="#local-explanations"><span class="header-section-number">18.2</span> Local Explanations</a></li>
  <li><a href="#global-explanations" id="toc-global-explanations" class="nav-link" data-scroll-target="#global-explanations"><span class="header-section-number">18.3</span> Global Explanations</a></li>
  <li><a href="#building-global-explanations-from-local-explanations" id="toc-building-global-explanations-from-local-explanations" class="nav-link" data-scroll-target="#building-global-explanations-from-local-explanations"><span class="header-section-number">18.4</span> Building Global Explanations from Local Explanations</a></li>
  <li><a href="#back-to-beans" id="toc-back-to-beans" class="nav-link" data-scroll-target="#back-to-beans"><span class="header-section-number">18.5</span> Back to Beans!</a></li>
  <li><a href="#sec-explain-summary" id="toc-sec-explain-summary" class="nav-link" data-scroll-target="#sec-explain-summary"><span class="header-section-number">18.6</span> Chapter Summary</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/davidrsch/TMwRes/edit/main/18-explaining-models-and-predictions.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/davidrsch/TMwRes/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-explain" class="quarto-section-identifier"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>In Section @ref(model-types), we outlined a taxonomy of models and suggested that models typically are built as one or more of descriptive, inferential, or predictive. We suggested that model performance, as measured by appropriate metrics (like RMSE for regression or area under the ROC curve for classification), can be important for all modeling applications. Similarly, model explanations, answering <em>why</em> a model makes the predictions it does, can be important whether the purpose of your model is largely descriptive, to test a hypothesis, or to make a prediction. Answering the question “why?” allows modeling practitioners to understand which features were important in predictions and even how model predictions would change under different values for the features. This chapter covers how to ask a model why it makes the predictions it does.</p>
<p>For some models, like linear regression, it is usually clear how to explain why the model makes its predictions. The structure of a linear model contains coefficients for each predictor that are typically straightforward to interpret. For other models, like random forests that can capture nonlinear behavior by design, it is less transparent how to explain the model’s predictions from only the structure of the model itself. Instead, we can apply model explainer algorithms to generate understanding of predictions.</p>
<div class="rmdnote">
<p>There are two types of model explanations, <em>global</em> and <em>local</em>. Global model explanations provide an overall understanding aggregated over a whole set of observations; local model explanations provide information about a prediction for a single observation.</p>
</div>
<section id="software-for-model-explanations" class="level2" data-number="18.1"><h2 data-number="18.1" class="anchored" data-anchor-id="software-for-model-explanations">
<span class="header-section-number">18.1</span> Software for Model Explanations</h2>
<p>The tidymodels framework does not itself contain software for model explanations. Instead, models trained and evaluated with tidymodels can be explained with other, supplementary software in R packages such as <a href="https://lime.data-imaginist.com/"><span class="pkg">lime</span></a>, <a href="https://koalaverse.github.io/vip/"><span class="pkg">vip</span></a>, and <a href="https://dalex.drwhy.ai/"><span class="pkg">DALEX</span></a>. We often choose:</p>
<ul>
<li>
<span class="pkg">vip</span> functions when we want to use <em>model-based</em> methods that take advantage of model structure (and are often faster)</li>
<li>
<span class="pkg">DALEX</span> functions when we want to use <em>model-agnostic</em> methods that can be applied to any model</li>
</ul>
<p>In Chapters @ref(resampling) and @ref(compare), we trained and compared several models to predict the price of homes in Ames, IA, including a linear model with interactions and a random forest model, with results shown in Figure @ref(fig:explain-obs-pred).</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-obs-pred_c8950fe6d8e6c6f03120c42cb2c3302e">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/explain-obs-pred-1.png" class="img-fluid figure-img" alt="Comparing predicted prices for a linear model with interactions and a random forest model. The random forest results in more accurate predictions." width="672"></p>
<figcaption class="figure-caption">Comparing predicted prices for a linear model with interactions and a random forest model</figcaption></figure>
</div>
</div>
</div>
<p>Let’s build model-agnostic explainers for both of these models to find out why they make these predictions. We can use the <span class="pkg">DALEXtra</span> add-on package for <span class="pkg">DALEX</span>, which provides support for tidymodels. <span class="citation" data-cites="Biecek2021">Biecek and Burzykowski (<a href="references.html#ref-Biecek2021" role="doc-biblioref">2021</a>)</span> provide a thorough exploration of how to use <span class="pkg">DALEX</span> for model explanations; this chapter only summarizes some important approaches, specific to tidymodels. To compute any kind of model explanation, global or local, using <span class="pkg">DALEX</span>, we first prepare the appropriate data and then create an <em>explainer</em> for each model:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-explainers_285a37223f79e721e5ca6f629b8f88a6">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ModelOriented.github.io/DALEXtra/">DALEXtra</a></span><span class="op">)</span></span>
<span><span class="va">vip_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neighborhood"</span>, <span class="st">"Gr_Liv_Area"</span>, <span class="st">"Year_Built"</span>, </span>
<span>                  <span class="st">"Bldg_Type"</span>, <span class="st">"Latitude"</span>, <span class="st">"Longitude"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vip_train</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">ames_train</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="fu">all_of</span><span class="op">(</span><span class="va">vip_features</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">explainer_lm</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://ModelOriented.github.io/DALEXtra/reference/explain_tidymodels.html">explain_tidymodels</a></span><span class="op">(</span></span>
<span>    <span class="va">lm_fit</span>, </span>
<span>    data <span class="op">=</span> <span class="va">vip_train</span>, </span>
<span>    y <span class="op">=</span> <span class="va">ames_train</span><span class="op">$</span><span class="va">Sale_Price</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"lm + interactions"</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">explainer_rf</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://ModelOriented.github.io/DALEXtra/reference/explain_tidymodels.html">explain_tidymodels</a></span><span class="op">(</span></span>
<span>    <span class="va">rf_fit</span>, </span>
<span>    data <span class="op">=</span> <span class="va">vip_train</span>, </span>
<span>    y <span class="op">=</span> <span class="va">ames_train</span><span class="op">$</span><span class="va">Sale_Price</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"random forest"</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="rmdwarning">
<p>A linear model is typically straightforward to interpret and explain; you may not often find yourself using separate model explanation algorithms for a linear model. However, it can sometimes be difficult to understand or explain the predictions of even a linear model once it has splines and interaction terms!</p>
</div>
<p>Dealing with significant feature engineering transformations during model explainability highlights some options we have (or sometimes, ambiguity in such analyses). We can quantify global or local model explanations either in terms of:</p>
<ul>
<li>
<em>original, basic predictors</em> as they existed without significant feature engineering transformations, or</li>
<li>
<em>derived features</em>, such as those created via dimensionality reduction (Chapter @ref(dimensionality)) or interactions and spline terms, as in this example.</li>
</ul></section><section id="local-explanations" class="level2" data-number="18.2"><h2 data-number="18.2" class="anchored" data-anchor-id="local-explanations">
<span class="header-section-number">18.2</span> Local Explanations</h2>
<p>Local model explanations provide information about a prediction for a single observation. For example, let’s consider an older duplex in the North Ames neighborhood (Section @ref(exploring-features-of-homes-in-ames)):</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex_03a72cd9b13ea9f1bf171bf9c9febf67">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">duplex</span> <span class="op">&lt;-</span> <span class="va">vip_train</span><span class="op">[</span><span class="fl">120</span>,<span class="op">]</span></span>
<span><span class="va">duplex</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   Neighborhood Gr_Liv_Area Year_Built Bldg_Type Latitude Longitude</span></span>
<span><span class="co">##   &lt;fct&gt;              &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt;        &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 North_Ames          1040       1949 Duplex        42.0     -93.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are multiple possible approaches to understanding why a model predicts a given price for this duplex. One is a break-down explanation, implemented with the <span class="pkg">DALEX</span> function <code><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts()</a></code>; it computes how contributions attributed to individual features change the mean model’s prediction for a particular observation, like our duplex. For the linear model, the duplex status (<code>Bldg_Type = 3</code>),<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> size, longitude, and age all contribute the most to the price being driven down from the intercept:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex-lm-breakdown_126c32f829fdc71f517b6cf33c31af7e">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_breakdown</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span>explainer <span class="op">=</span> <span class="va">explainer_lm</span>, new_observation <span class="op">=</span> <span class="va">duplex</span><span class="op">)</span></span>
<span><span class="va">lm_breakdown</span></span>
<span><span class="co">##                                           contribution</span></span>
<span><span class="co">## lm + interactions: intercept                     5.221</span></span>
<span><span class="co">## lm + interactions: Gr_Liv_Area = 1040           -0.082</span></span>
<span><span class="co">## lm + interactions: Bldg_Type = 3                -0.049</span></span>
<span><span class="co">## lm + interactions: Longitude = -93.608903       -0.043</span></span>
<span><span class="co">## lm + interactions: Year_Built = 1949            -0.039</span></span>
<span><span class="co">## lm + interactions: Latitude = 42.035841         -0.007</span></span>
<span><span class="co">## lm + interactions: Neighborhood = 1              0.001</span></span>
<span><span class="co">## lm + interactions: prediction                    5.002</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since this linear model was trained using spline terms for latitude and longitude, the contribution to price for <code>Longitude</code> shown here combines the effects of all of its individual spline terms. The contribution is in terms of the original <code>Longitude</code> feature, not the derived spline features.</p>
<p>The most important features are slightly different for the random forest model, with the size, age, and duplex status being most important:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex-rf-breakdown_66f5da84d716f905e174052ffc8fe915">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rf_breakdown</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span>explainer <span class="op">=</span> <span class="va">explainer_rf</span>, new_observation <span class="op">=</span> <span class="va">duplex</span><span class="op">)</span></span>
<span><span class="va">rf_breakdown</span></span>
<span><span class="co">##                                       contribution</span></span>
<span><span class="co">## random forest: intercept                     5.221</span></span>
<span><span class="co">## random forest: Year_Built = 1949            -0.076</span></span>
<span><span class="co">## random forest: Gr_Liv_Area = 1040           -0.075</span></span>
<span><span class="co">## random forest: Bldg_Type = 3                -0.027</span></span>
<span><span class="co">## random forest: Longitude = -93.608903       -0.043</span></span>
<span><span class="co">## random forest: Latitude = 42.035841         -0.028</span></span>
<span><span class="co">## random forest: Neighborhood = 1             -0.003</span></span>
<span><span class="co">## random forest: prediction                    4.969</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="rmdwarning">
<p>Model break-down explanations like these depend on the <em>order</em> of the features.</p>
</div>
<p>If we choose the <code>order</code> for the random forest model explanation to be the same as the default for the linear model (chosen via a heuristic), we can change the relative importance of the features:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex-rf-breakdown-reorder_a9a5cecf8f68ba0080cca590ac32f670">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span></span>
<span>  explainer <span class="op">=</span> <span class="va">explainer_rf</span>, </span>
<span>  new_observation <span class="op">=</span> <span class="va">duplex</span>,</span>
<span>  order <span class="op">=</span> <span class="va">lm_breakdown</span><span class="op">$</span><span class="va">variable_name</span></span>
<span><span class="op">)</span></span>
<span><span class="co">##                                       contribution</span></span>
<span><span class="co">## random forest: intercept                     5.221</span></span>
<span><span class="co">## random forest: Gr_Liv_Area = 1040           -0.075</span></span>
<span><span class="co">## random forest: Bldg_Type = 3                -0.019</span></span>
<span><span class="co">## random forest: Longitude = -93.608903       -0.023</span></span>
<span><span class="co">## random forest: Year_Built = 1949            -0.104</span></span>
<span><span class="co">## random forest: Latitude = 42.035841         -0.028</span></span>
<span><span class="co">## random forest: Neighborhood = 1             -0.003</span></span>
<span><span class="co">## random forest: prediction                    4.969</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the fact that these break-down explanations change based on order to compute the most important features over all (or many) possible orderings. This is the idea behind Shapley Additive Explanations <span class="citation" data-cites="Lundberg2017">(<a href="references.html#ref-Lundberg2017" role="doc-biblioref">Lundberg and Lee 2017</a>)</span>, where the average contributions of features are computed under different combinations or “coalitions” of feature orderings. Let’s compute SHAP attributions for our duplex, using <code>B = 20</code> random orderings:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex-rf-shap-calc_6fc6f6e7dab8b484e46af77cb37addd2">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1801</span><span class="op">)</span></span>
<span><span class="va">shap_duplex</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span></span>
<span>    explainer <span class="op">=</span> <span class="va">explainer_rf</span>, </span>
<span>    new_observation <span class="op">=</span> <span class="va">duplex</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"shap"</span>,</span>
<span>    B <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could use the default plot method from <span class="pkg">DALEX</span> by calling <code>plot(shap_duplex)</code>, or we can access the underlying data and create a custom plot. The box plots in Figure @ref(fig:duplex-rf-shap) display the distribution of contributions across all the orderings we tried, and the bars display the average attribution for each feature:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-duplex-rf-shap_8c8f7c853b17a18b3ebf882905f999aa">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/">forcats</a></span><span class="op">)</span></span>
<span><span class="va">shap_duplex</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">variable</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>mean_val <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">contribution</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">mean_val</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">contribution</span>, <span class="va">variable</span>, fill <span class="op">=</span> <span class="va">mean_val</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span>data <span class="op">=</span> <span class="op">~</span><span class="fu">distinct</span><span class="op">(</span><span class="va">.</span>, <span class="va">variable</span>, <span class="va">mean_val</span><span class="op">)</span>, </span>
<span>           <span class="fu">aes</span><span class="op">(</span><span class="va">mean_val</span>, <span class="va">variable</span><span class="op">)</span>, </span>
<span>           alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_boxplot</span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_viridis_d</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/duplex-rf-shap_db9e2c5dd4d9379f888da6f9a18742a0">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/duplex-rf-shap-1.png" class="img-fluid figure-img" alt="Shapley additive explanations from the random forest model for a duplex property. Year built and gross living area have the largest contributions." width="672"></p>
<figcaption class="figure-caption">Shapley additive explanations from the random forest model for a duplex property</figcaption></figure>
</div>
</div>
</div>
<p>What about a different observation in our data set? Let’s look at a larger, newer one-family home in the Gilbert neighborhood:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-gilbert_736b273872825039d92007d6514adb32">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">big_house</span> <span class="op">&lt;-</span> <span class="va">vip_train</span><span class="op">[</span><span class="fl">1269</span>,<span class="op">]</span></span>
<span><span class="va">big_house</span></span>
<span><span class="co">## # A tibble: 1 × 6</span></span>
<span><span class="co">##   Neighborhood Gr_Liv_Area Year_Built Bldg_Type Latitude Longitude</span></span>
<span><span class="co">##   &lt;fct&gt;              &lt;dbl&gt;      &lt;dbl&gt; &lt;fct&gt;        &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Gilbert             2267       2002 OneFam        42.1     -93.6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can compute SHAP average attributions for this house in the same way:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-gilbert-shap-calc_d9d731b591438fafe120320966d4888a">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1802</span><span class="op">)</span></span>
<span><span class="va">shap_house</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/predict_parts.html">predict_parts</a></span><span class="op">(</span></span>
<span>    explainer <span class="op">=</span> <span class="va">explainer_rf</span>, </span>
<span>    new_observation <span class="op">=</span> <span class="va">big_house</span>, </span>
<span>    type <span class="op">=</span> <span class="st">"shap"</span>,</span>
<span>    B <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are shown in Figure @ref(fig:gilbert-shap); unlike the duplex, the size and age of this house contribute to its price being higher.</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/gilbert-shap_05ae0995c3daa69c8391c25e791a2d50">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/gilbert-shap-1.png" class="img-fluid figure-img" alt="Shapley additive explanations from the random forest model for a one-family home in Gilbert. Gross living area and year built have the largest contributions but in the opposite direction as the previous explainer." width="672"></p>
<figcaption class="figure-caption">Shapley additive explanations from the random forest model for a one-family home in Gilbert</figcaption></figure>
</div>
</div>
</div>
</section><section id="global-explanations" class="level2" data-number="18.3"><h2 data-number="18.3" class="anchored" data-anchor-id="global-explanations">
<span class="header-section-number">18.3</span> Global Explanations</h2>
<p>Global model explanations, also called global feature importance or variable importance, help us understand which features are most important in driving the predictions of the linear and random forest models overall, aggregated over the whole training set. While the previous section addressed which variables or features are most important in predicting sale price for an individual home, global feature importance addresses the most important variables for a model in aggregate.</p>
<div class="rmdnote">
<p>One way to compute variable importance is to <em>permute</em> the features <span class="citation" data-cites="breiman2001random">(<a href="references.html#ref-breiman2001random" role="doc-biblioref">Breiman 2001</a>)</span>. We can permute or shuffle the values of a feature, predict from the model, and then measure how much worse the model fits the data compared to before shuffling.</p>
</div>
<p>If shuffling a column causes a large degradation in model performance, it is important; if shuffling a column’s values doesn’t make much difference to how the model performs, it must not be an important variable. This approach can be applied to any kind of model (it is <em>model agnostic</em>), and the results are straightforward to understand.</p>
<p>Using <span class="pkg">DALEX</span>, we compute this kind of variable importance via the <code><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts()</a></code> function.</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-global-calcs_6aadeee8a2afa96d0db11835c4948202">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1803</span><span class="op">)</span></span>
<span><span class="va">vip_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts</a></span><span class="op">(</span><span class="va">explainer_lm</span>, loss_function <span class="op">=</span> <span class="va">loss_root_mean_square</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1804</span><span class="op">)</span></span>
<span><span class="va">vip_rf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts</a></span><span class="op">(</span><span class="va">explainer_rf</span>, loss_function <span class="op">=</span> <span class="va">loss_root_mean_square</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, we could use the default plot method from <span class="pkg">DALEX</span> by calling <code>plot(vip_lm, vip_rf)</code> but the underlying data is available for exploration, analysis, and plotting. Let’s create a function for plotting:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-global-func_fd329f181366032de6d05b94b37b1430">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ggplot_imp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">metric_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">obj</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"loss_name"</span><span class="op">)</span></span>
<span>  <span class="va">metric_lab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">metric_name</span>, </span>
<span>                      <span class="st">"after permutations\n(higher indicates more important)"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">full_vip</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">!=</span> <span class="st">"_baseline_"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">perm_vals</span> <span class="op">&lt;-</span> <span class="va">full_vip</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">==</span> <span class="st">"_full_model_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">label</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">summarise</span><span class="op">(</span>dropout_loss <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dropout_loss</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">full_vip</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op">!=</span> <span class="st">"_full_model_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_reorder.html">fct_reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">dropout_loss</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">dropout_loss</span>, <span class="va">variable</span><span class="op">)</span><span class="op">)</span> </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> </span>
<span>      <span class="fu">facet_wrap</span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">perm_vals</span>, <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">dropout_loss</span>, color <span class="op">=</span> <span class="va">label</span><span class="op">)</span>,</span>
<span>                 linewidth <span class="op">=</span> <span class="fl">1.4</span>, lty <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_boxplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">label</span>, fill <span class="op">=</span> <span class="va">label</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> </span>
<span>      <span class="fu">geom_vline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">perm_vals</span>, <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">dropout_loss</span><span class="op">)</span>,</span>
<span>                 linewidth <span class="op">=</span> <span class="fl">1.4</span>, lty <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_boxplot</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#91CBD765"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">p</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="va">metric_lab</span>, </span>
<span>         y <span class="op">=</span> <span class="cn">NULL</span>,  fill <span class="op">=</span> <span class="cn">NULL</span>,  color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>ggplot_imp(vip_lm, vip_rf)</code> produces Figure @ref(fig:global-rf).</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/global-rf_1455816e2046ab024dbd0c5c8abbe6cb">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/global-rf-1.png" class="img-fluid figure-img" alt="Global explainer for the random forest and linear regression models. For both models, gross living area and year built have the largest contributions, but the linear model uses the neighborhood predictor to a large degree." width="768"></p>
<figcaption class="figure-caption">Global explainer for the random forest and linear regression models</figcaption></figure>
</div>
</div>
</div>
<p>The dashed line in each panel of Figure @ref(fig:global-rf) shows the RMSE for the full model, either the linear model or the random forest model. Features farther to the right are more important, because permuting them results in higher RMSE. There is quite a lot of interesting information to learn from this plot; for example, neighborhood is quite important in the linear model with interactions/splines but the second least important feature for the random forest model.</p>
</section><section id="building-global-explanations-from-local-explanations" class="level2" data-number="18.4"><h2 data-number="18.4" class="anchored" data-anchor-id="building-global-explanations-from-local-explanations">
<span class="header-section-number">18.4</span> Building Global Explanations from Local Explanations</h2>
<p>So far in this chapter, we have focused on local model explanations for a single observation (via Shapley additive explanations) and global model explanations for a data set as a whole (via permuting features). It is also possible to build global model explanations by aggregating local model explanations, as with <em>partial dependence profiles</em>.</p>
<div class="rmdnote">
<p>Partial dependence profiles show how the expected value of a model prediction, like the predicted price of a home in Ames, changes as a function of a feature, like the age or gross living area.</p>
</div>
<p>One way to build such a profile is by aggregating or averaging profiles for individual observations. A profile showing how an individual observation’s prediction changes as a function of a given feature is called an ICE (individual conditional expectation) profile or a CP (<em>ceteris paribus</em>) profile. We can compute such individual profiles (for 500 of the observations in our training set) and then aggregate them using the <span class="pkg">DALEX</span> function <code><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html">model_profile()</a></code>:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-year-built-pdp-calc_eb9846b366f601c587ad47872d1ba89d">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1805</span><span class="op">)</span></span>
<span><span class="va">pdp_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html">model_profile</a></span><span class="op">(</span><span class="va">explainer_rf</span>, N <span class="op">=</span> <span class="fl">500</span>, variables <span class="op">=</span> <span class="st">"Year_Built"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create another function for plotting the underlying data in this object:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-pdp-func_45022b776a5ad98195c227b0f61648a9">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ggplot_pdp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">as_tibble</span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">agr_profiles</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>`_label_` <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">`_label_`</span>, <span class="st">"^[^_]*_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">`_x_`</span>, <span class="va">`_yhat_`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">cp_profiles</span><span class="op">)</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="op">{</span><span class="op">{</span> <span class="va">x</span> <span class="op">}</span><span class="op">}</span>, group <span class="op">=</span> <span class="va">`_ids_`</span><span class="op">)</span>,</span>
<span>              linewidth <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">num_colors</span> <span class="op">&lt;-</span> <span class="fu">n_distinct</span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">agr_profiles</span><span class="op">$</span><span class="va">`_label_`</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">num_colors</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">`_label_`</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"midnightblue"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">p</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using this function generates Figure @ref(fig:year-built), where we can see the nonlinear behavior of the random forest model.</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-year-built_a5f1d2edc15ce21a0f280e89589b3b29">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot_pdp</span><span class="op">(</span><span class="va">pdp_age</span>, <span class="va">Year_Built</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Year built"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Sale Price (log)"</span>, </span>
<span>       color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/year-built_701318fe5ef6e483eb04fd8f017d8b3a">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/year-built-1.png" class="img-fluid figure-img" alt="Partial dependence profiles for the random forest model focusing on the year built predictor. The profiles are mostly relatively constant but then increase linearly around 1950." width="672"></p>
<figcaption class="figure-caption">Partial dependence profiles for the random forest model focusing on the year built predictor</figcaption></figure>
</div>
</div>
</div>
<p>Sale price for houses built in different years is mostly flat, with a modest rise after about 1960. Partial dependence profiles can be computed for any other feature in the model, and also for groups in the data, such as <code>Bldg_Type</code>. Let’s use 1,000 observations for these profiles.</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-build-type-pdp_01d2837c7023e79820c55a14960571f5">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1806</span><span class="op">)</span></span>
<span><span class="va">pdp_liv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_profile.html">model_profile</a></span><span class="op">(</span><span class="va">explainer_rf</span>, N <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>                         variables <span class="op">=</span> <span class="st">"Gr_Liv_Area"</span>, </span>
<span>                         groups <span class="op">=</span> <span class="st">"Bldg_Type"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot_pdp</span><span class="op">(</span><span class="va">pdp_liv</span>, <span class="va">Gr_Liv_Area</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Gross living area"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Sale Price (log)"</span>, </span>
<span>       color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code produces Figure @ref(fig:building-type-profiles), where we see that sale price increases the most between about 1,000 and 3,000 square feet of living area, and that different home types (like single family homes or different types of townhouses) mostly exhibit similar increasing trends in price with more living space.</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/building-type-profiles_dc804ea20d480b23bcdbf1aa3fde3294">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/building-type-profiles-1.png" class="img-fluid figure-img" alt="Partial dependence profiles for the random forest model focusing on building types and gross living area. The building type profiles are, for the most part, parallel over gross living area." width="672"></p>
<figcaption class="figure-caption">Partial dependence profiles for the random forest model focusing on building types and gross living area</figcaption></figure>
</div>
</div>
</div>
<p>We have the option of using <code>plot(pdp_liv)</code> for default <span class="pkg">DALEX</span> plots, but since we are making plots with the underlying data here, we can even facet by one of the features to visualize if the predictions change differently and highlighting the imbalance in these subgroups (as shown in Figure @ref(fig:building-type-facets)).</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-build-type-facet_003c156518f18e9e34e00eada9e6eff6">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">as_tibble</span><span class="op">(</span><span class="va">pdp_liv</span><span class="op">$</span><span class="va">agr_profiles</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Bldg_Type <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span><span class="op">(</span><span class="va">`_label_`</span>, <span class="st">"random forest_"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">`_x_`</span>, <span class="va">`_yhat_`</span>, color <span class="op">=</span> <span class="va">Bldg_Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">pdp_liv</span><span class="op">$</span><span class="va">cp_profiles</span><span class="op">)</span>,</span>
<span>            <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Gr_Liv_Area</span>, group <span class="op">=</span> <span class="va">`_ids_`</span><span class="op">)</span>,</span>
<span>            linewidth <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.1</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_log10</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Bldg_Type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Gross living area"</span>, </span>
<span>       y <span class="op">=</span> <span class="st">"Sale Price (log)"</span>, </span>
<span>       color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/building-type-facets_88184eabf961c72bbbe5f35d6f63f869">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/building-type-facets-1.png" class="img-fluid figure-img" alt="Partial dependence profiles for the random forest model focusing on building types and gross living area using facets. The building type profiles are, for the most part, parallel over gross living area." width="672"></p>
<figcaption class="figure-caption">Partial dependence profiles for the random forest model focusing on building types and gross living area using facets</figcaption></figure>
</div>
</div>
</div>
<p>There is no one correct approach for building model explanations, and the options outlined in this chapter are not exhaustive. We have highlighted good options for explanations at both the individual and global level, as well as how to bridge from one to the other, and we point you to <span class="citation" data-cites="Biecek2021">Biecek and Burzykowski (<a href="references.html#ref-Biecek2021" role="doc-biblioref">2021</a>)</span> and <span class="citation" data-cites="Molnar2021">Molnar (<a href="references.html#ref-Molnar2021" role="doc-biblioref">2020</a>)</span> for further reading.</p>
</section><section id="back-to-beans" class="level2" data-number="18.5"><h2 data-number="18.5" class="anchored" data-anchor-id="back-to-beans">
<span class="header-section-number">18.5</span> Back to Beans!</h2>
<p>In Chapter @ref(dimensionality), we discussed how to use dimensionality reduction as a feature engineering or preprocessing step when modeling high-dimensional data. For our example data set of dry bean morphology measures predicting bean type, we saw great results from partial least squares (PLS) dimensionality reduction combined with a regularized discriminant analysis model. Which of those morphological characteristics were <em>most</em> important in the bean type predictions? We can use the same approach outlined throughout this chapter to create a model-agnostic explainer and compute, say, global model explanations via <code><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts()</a></code>:</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/explain-bea-vip_30d67ac96cc2c239fcc1ca5131e87ca2">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1807</span><span class="op">)</span></span>
<span><span class="va">vip_beans</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://ModelOriented.github.io/DALEXtra/reference/explain_tidymodels.html">explain_tidymodels</a></span><span class="op">(</span></span>
<span>    <span class="va">rda_wflow_fit</span>, </span>
<span>    data <span class="op">=</span> <span class="va">bean_train</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">class</span><span class="op">)</span>, </span>
<span>    y <span class="op">=</span> <span class="va">bean_train</span><span class="op">$</span><span class="va">class</span>,</span>
<span>    label <span class="op">=</span> <span class="st">"RDA"</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://modeloriented.github.io/DALEX/reference/model_parts.html">model_parts</a></span><span class="op">(</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using our previously defined importance plotting function, <code>ggplot_imp(vip_beans)</code> produces Figure @ref(fig:bean-explainer).</p>
<div class="cell" data-layout-align="center" data-hash="18-explaining-models-and-predictions_cache/html/bean-explainer_c4cfafc2fbbe8e5231784b697490a0b6">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="figures/bean-explainer-1.png" class="img-fluid figure-img" alt="Global explainer for the regularized discriminant analysis model on the beans data. Almost all predictors have a significant contribution with shape factors one and four contributing the most. " width="768"></p>
<figcaption class="figure-caption">Global explainer for the regularized discriminant analysis model on the beans data</figcaption></figure>
</div>
</div>
</div>
<div class="rmdwarning">
<p>The measures of global feature importance that we see in Figure @ref(fig:bean-explainer) incorporate the effects of all of the PLS components, but in terms of the original variables.</p>
</div>
<p>Figure @ref(fig:bean-explainer) shows us that shape factors are among the most important features for predicting bean type, especially shape factor 4, a measure of solidity that takes into account the area <span class="math inline">\(A\)</span>, major axis <span class="math inline">\(L\)</span>, and minor axis <span class="math inline">\(l\)</span>:</p>
<p><span class="math display">\[\text{SF4} = \frac{A}{\pi(L/2)(l/2)}\]</span></p>
<p>We can see from Figure @ref(fig:bean-explainer) that shape factor 1 (the ratio of the major axis to the area), the minor axis length, and roundness are the next most important bean characteristics for predicting bean variety.</p>
</section><section id="sec-explain-summary" class="level2" data-number="18.6"><h2 data-number="18.6" class="anchored" data-anchor-id="sec-explain-summary">
<span class="header-section-number">18.6</span> Chapter Summary</h2>
<p>For some types of models, the answer to why a model made a certain prediction is straightforward, but for other types of models, we must use separate explainer algorithms to understand what features are relatively most important for predictions. You can generate two main kinds of model explanations from a trained model. Global explanations provide information aggregated over an entire data set, while local explanations provide understanding about a model’s predictions for a single observation.</p>
<p>Packages such as <span class="pkg">DALEX</span> and its supporting package <span class="pkg">DALEXtra</span>, <span class="pkg">vip</span>, and <span class="pkg">lime</span> can be integrated into a tidymodels analysis to provide these model explainers. Model explanations are just one piece of understanding whether your model is appropriate and effective, along with estimates of model performance; Chapter @ref(trust) further explores the quality and trustworthiness of predictions.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Biecek2021" class="csl-entry" role="listitem">
Biecek, Przemyslaw, and Tomasz Burzykowski. 2021. <em><span>Explanatory Model Analysis</span></em>. Chapman; Hall/CRC, New York. <a href="https://ema.drwhy.ai/">https://ema.drwhy.ai/</a>.
</div>
<div id="ref-breiman2001random" class="csl-entry" role="listitem">
Breiman, L. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32.
</div>
<div id="ref-Lundberg2017" class="csl-entry" role="listitem">
Lundberg, Scott M., and Su-In Lee. 2017. <span>“A Unified Approach to Interpreting Model Predictions.”</span> In <em>Proceedings of the 31st International Conference on Neural Information Processing Systems</em>, 4768–77. NIPS’17. Red Hook, NY, USA: Curran Associates Inc.
</div>
<div id="ref-Molnar2021" class="csl-entry" role="listitem">
Molnar, Christopher. 2020. <em><span>Interpretable Machine Learning</span></em>. lulu.com. <a href="https://christophm.github.io/interpretable-ml-book/">https://christophm.github.io/interpretable-ml-book/</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Notice that this package for model explanations focuses on the <em>level</em> of categorical predictors in this type of output, like <code>Bldg_Type = 3</code> for duplex and <code>Neighborhood = 1</code> for North Ames.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./17-encoding-categorical-data.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Encoding Categorical Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./19-when-should-you-trust-predictions.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Modelado Ordenado con R fue escrito por Max Kuhn, y Julia Silge.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>