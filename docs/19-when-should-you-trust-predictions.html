<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Max Kuhn, y Julia Silge">
<title>Modelado Ordenado con R - 19&nbsp; When Should You Trust Your Predictions?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./20-ensemble-models.html" rel="next">
<link href="./18-explaining-models-and-predictions.html" rel="prev">
<link href="./images/cover.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="TMwR.css">
</head>
<body class="nav-sidebar floating">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./16-dimensionality-reduction.html">BEYOND THE BASICS</a></li><li class="breadcrumb-item"><a href="./19-when-should-you-trust-predictions.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modelado Ordenado con R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/davidrsch/TMwRes" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hello World</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">INTRODUCTION</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-software-modeling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Software for modeling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">A Tidyverse Primer</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-base-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">A Review of R Modeling Fundamentals</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">MODELING BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-ames.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Ames Housing Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-data-spending.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spending our Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-fitting-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Fitting Models with parsnip</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-the-model-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">A Model Workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-feature-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Feature Engineering with recipes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-judging-model-effectiveness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Judging Model Effectiveness</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">TOOLS FOR CREATING EFFECTIVE MODELS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-resampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resampling for Evaluating Performance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-comparing-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Comparing Models with Resampling</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-tuning-parameters.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Model Tuning and the Dangers of Overfitting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-grid-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Grid Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-iterative-search.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Iterative Search</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-workflow-sets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Screening Many Models</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">BEYOND THE BASICS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-dimensionality-reduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Dimensionality Reduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-encoding-categorical-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Encoding Categorical Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-explaining-models-and-predictions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19-when-should-you-trust-predictions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-ensemble-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-inferential-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Inferential Analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pre-proc-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Recommended Preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-equivocal-zones" id="toc-sec-equivocal-zones" class="nav-link active" data-scroll-target="#sec-equivocal-zones"><span class="header-section-number">19.1</span> Equivocal Results</a></li>
  <li><a href="#sec-applicability-domains" id="toc-sec-applicability-domains" class="nav-link" data-scroll-target="#sec-applicability-domains"><span class="header-section-number">19.2</span> Determining Model Applicability</a></li>
  <li><a href="#sec-trust-summary" id="toc-sec-trust-summary" class="nav-link" data-scroll-target="#sec-trust-summary"><span class="header-section-number">19.3</span> Chapter Summary</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/davidrsch/TMwRes/edit/main/19-when-should-you-trust-predictions.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/davidrsch/TMwRes/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-trust" class="quarto-section-identifier"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">When Should You Trust Your Predictions?</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>A predictive model can almost always produce a prediction, given input data. However, in plenty of situations it is inappropriate to produce such a prediction. When a new data point is well outside of the range of data used to create the model, making a prediction may be an inappropriate <em>extrapolation</em>. A more qualitative example of an inappropriate prediction would be when the model is used in a completely different context. The cell segmentation data used in <a href="14-iterative-search.html">Chapter&nbsp;<span>14</span></a> flags when human breast cancer cells can or cannot be accurately isolated inside an image. A model built from these data could be inappropriately applied to stomach cells for the same purpose. We can produce a prediction but it is unlikely to be applicable to the different cell type.</p>
<p>This chapter discusses two methods for quantifying the potential quality of a prediction:</p>
<ul>
<li>
<em>Equivocal zones</em> use the predicted values to alert the user that results may be suspect.</li>
<li>
<em>Applicability</em> uses the predictors to measure the amount of extrapolation (if any) for new samples.</li>
</ul>
<section id="sec-equivocal-zones" class="level2" data-number="19.1"><h2 data-number="19.1" class="anchored" data-anchor-id="sec-equivocal-zones">
<span class="header-section-number">19.1</span> Equivocal Results</h2>
<div class="rmdwarning">
<p>In some cases, the amount of uncertainty associated with a prediction is too high to be trusted.</p>
</div>
<p>If a model result indicated that you had a 51% chance of having contracted COVID-19, it would be natural to view the diagnosis with some skepticism. In fact, regulatory bodies often require many medical diagnostics to have an <em>equivocal zone</em>. This zone is a range of results in which the prediction should not be reported to patients, for example, some range of COVID-19 test results that are too uncertain to be reported to a patient. See <span class="citation" data-cites="Danowski524">Danowski et al. (<a href="references.html#ref-Danowski524" role="doc-biblioref">1970</a>)</span> and <span class="citation" data-cites="Kerleguer1783">Kerleguer et al. (<a href="references.html#ref-Kerleguer1783" role="doc-biblioref">2003</a>)</span> for examples. The same notion can be applied to models created outside of medical diagnostics.</p>
<p>Let’s use a function that can simulate classification data with two classes and two predictors (<code>x</code> and <code>y</code>). The true model is a logistic regression model with the equation:</p>
<p><span class="math display">\[
\mathrm{logit}(p) = -1 - 2x - \frac{x^2}{5} + 2y^2
\]</span></p>
<p>The two predictors follow a bivariate normal distribution with a correlation of 0.70. We’ll create a training set of 200 samples and a test set of 50:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-simulation_112c4655ff2f6a35b895cd0d53d531ff">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://tidymodels.tidymodels.org/reference/tidymodels_prefer.html">tidymodels_prefer</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simulate_two_classes</span> <span class="op">&lt;-</span> </span>
<span>  <span class="kw">function</span> <span class="op">(</span><span class="va">n</span>, <span class="va">error</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">eqn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html">quote</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">x</span> <span class="op">-</span> <span class="fl">0.2</span> <span class="op">*</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op">{</span></span>
<span>    <span class="co"># Slightly correlated predictors</span></span>
<span>    <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span>, <span class="fl">1</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span></span>
<span>    <span class="va">cls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"class_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">dat</span> <span class="op">&lt;-</span> </span>
<span>      <span class="fu">as_tibble</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        linear_pred <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">eqn</span>,</span>
<span>        <span class="co"># Add some misclassification noise</span></span>
<span>        linear_pred <span class="op">=</span> <span class="va">linear_pred</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="va">error</span><span class="op">)</span>,</span>
<span>        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">linear_pred</span><span class="op">)</span>,</span>
<span>        class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">prob</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">cls</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">cls</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">class</span>, levels <span class="op">=</span> <span class="va">cls</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">class</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1901</span><span class="op">)</span></span>
<span><span class="va">training_set</span> <span class="op">&lt;-</span> <span class="fu">simulate_two_classes</span><span class="op">(</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">testing_set</span>  <span class="op">&lt;-</span> <span class="fu">simulate_two_classes</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We estimate a logistic regression model using Bayesian methods (using the default Gaussian prior distributions for the parameters):</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-bayes-glm_0ba020bc077240480ba10228cec64312">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">two_class_mod</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">logistic_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"stan"</span>, seed <span class="op">=</span> <span class="fl">1902</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">fit</span><span class="op">(</span><span class="va">class</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">training_set</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">two_class_mod</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">## parsnip model object</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## stan_glm</span></span>
<span><span class="co">##  family:       binomial [logit]</span></span>
<span><span class="co">##  formula:      class ~ . + I(x^2) + I(y^2)</span></span>
<span><span class="co">##  observations: 200</span></span>
<span><span class="co">##  predictors:   5</span></span>
<span><span class="co">## ------</span></span>
<span><span class="co">##             Median MAD_SD</span></span>
<span><span class="co">## (Intercept)  1.092  0.287</span></span>
<span><span class="co">## x            2.290  0.423</span></span>
<span><span class="co">## y            0.314  0.354</span></span>
<span><span class="co">## I(x^2)       0.077  0.307</span></span>
<span><span class="co">## I(y^2)      -2.465  0.424</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ------</span></span>
<span><span class="co">## * For help interpreting the printed output see ?print.stanreg</span></span>
<span><span class="co">## * For info on the priors used see ?prior_summary.stanreg</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The fitted class boundary is overlaid onto the test set in <a href="#fig-glm-boundaries">Figure&nbsp;<span>19.1</span></a>. The data points closest to the class boundary are the most uncertain. If their values changed slightly, their predicted class might change. One simple method for disqualifying some results is to call them “equivocal” if the values are within some range around 50% (or the appropriate probability cutoff for a certain situation). Depending on the problem the model is being applied to, this might indicate we should collect another measurement or we require more information before a trustworthy prediction is possible.</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-glm-boundaries_843d3a5f36a8c0374eac13d5526aa6ba">
<div class="cell-output-display">
<div id="fig-glm-boundaries" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-glm-boundaries-1.png" class="img-fluid figure-img" style="width:70.0%" alt="Simulated two-class data set with a logistic regression fit and decision boundary. The scatter plot of the two classes shows fairly correlated data. The decision boundary is a parabola in the x axis that does a good job of separating the classes."></p>
<figcaption class="figure-caption">Figure&nbsp;19.1: Simulated two-class data set with a logistic regression fit and decision boundary.</figcaption></figure>
</div>
</div>
</div>
<p>We could base the width of the band around the cutoff on how performance improves when the uncertain results are removed. However, we should also estimate the reportable rate (the expected proportion of usable results). For example, it would not be useful in real-world situations to have perfect performance but release predictions on only 2% of the samples passed to the model.</p>
<p>Let’s use the test set to determine the balance between improving performance and having enough reportable results. The predictions are created using:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-bayes-glm-pred_bb55a105d49208ddae015ca155cac098">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_pred</span> <span class="op">&lt;-</span> <span class="fu">augment</span><span class="op">(</span><span class="va">two_class_mod</span>, <span class="va">testing_set</span><span class="op">)</span></span>
<span><span class="va">test_pred</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 6</span></span>
<span><span class="co">##   .pred_class .pred_class_1 .pred_class_2      x      y class  </span></span>
<span><span class="co">##   &lt;fct&gt;               &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;  </span></span>
<span><span class="co">## 1 class_2           0.0256          0.974  1.12  -0.176 class_2</span></span>
<span><span class="co">## 2 class_1           0.555           0.445 -0.126 -0.582 class_2</span></span>
<span><span class="co">## 3 class_2           0.00620         0.994  1.92   0.615 class_2</span></span>
<span><span class="co">## 4 class_2           0.472           0.528 -0.400  0.252 class_2</span></span>
<span><span class="co">## 5 class_2           0.163           0.837  1.30   1.09  class_1</span></span>
<span><span class="co">## 6 class_2           0.0317          0.968  2.59   1.36  class_2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With tidymodels, the <span class="pkg">probably</span> package contains functions for equivocal zones. For cases with two classes, the <code><a href="https://probably.tidymodels.org/reference/make_class_pred.html">make_two_class_pred()</a></code> function creates a factor-like column that has the predicted classes with an equivocal zone:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-make-eq_62e6d28aa388291d4f811d69e441f770">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/probably/">probably</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">lvls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">training_set</span><span class="op">$</span><span class="va">class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_pred</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">test_pred</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>.pred_with_eqz <span class="op">=</span> <span class="fu"><a href="https://probably.tidymodels.org/reference/make_class_pred.html">make_two_class_pred</a></span><span class="op">(</span><span class="va">.pred_class_1</span>, <span class="va">lvls</span>, buffer <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_pred</span> <span class="op">%&gt;%</span> <span class="fu">count</span><span class="op">(</span><span class="va">.pred_with_eqz</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 3 × 2</span></span>
<span><span class="co">##   .pred_with_eqz     n</span></span>
<span><span class="co">##       &lt;clss_prd&gt; &lt;int&gt;</span></span>
<span><span class="co">## 1           [EQ]     9</span></span>
<span><span class="co">## 2        class_1    20</span></span>
<span><span class="co">## 3        class_2    21</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Rows that are within <span class="math inline">\(0.50\pm0.15\)</span> are given a value of <code>[EQ]</code>.</p>
<div class="rmdnote">
<p>The notation <code>[EQ]</code> in this example is not a factor level but an attribute of that column.</p>
</div>
<p>Since the factor levels are the same as the original data, confusion matrices and other statistics can be computed without error. When using standard functions from the <span class="pkg">yardstick</span> package, the equivocal results are converted to <code>NA</code> and are not used in the calculations that use the hard class predictions. Notice the differences in these confusion matrices:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-conf-mat_dfa69832ebe8f7b3f161a46c0c5aaeb6">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># All data</span></span>
<span><span class="va">test_pred</span> <span class="op">%&gt;%</span> <span class="fu">conf_mat</span><span class="op">(</span><span class="va">class</span>, <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="co">##           Truth</span></span>
<span><span class="co">## Prediction class_1 class_2</span></span>
<span><span class="co">##    class_1      20       6</span></span>
<span><span class="co">##    class_2       5      19</span></span>
<span></span>
<span><span class="co"># Reportable results only: </span></span>
<span><span class="va">test_pred</span> <span class="op">%&gt;%</span> <span class="fu">conf_mat</span><span class="op">(</span><span class="va">class</span>, <span class="va">.pred_with_eqz</span><span class="op">)</span></span>
<span><span class="co">##           Truth</span></span>
<span><span class="co">## Prediction class_1 class_2</span></span>
<span><span class="co">##    class_1      17       3</span></span>
<span><span class="co">##    class_2       5      16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An <code><a href="https://probably.tidymodels.org/reference/locate-equivocal.html">is_equivocal()</a></code> function is also available for filtering these rows from the data.</p>
<p>Does the equivocal zone help improve accuracy? Let’s look at different buffer sizes, as shown in <a href="#fig-equivocal-zone-results">Figure&nbsp;<span>19.2</span></a>:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-eq-calcs_a26157f441fe7e35c0ead15393052068">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># A function to change the buffer then compute performance.</span></span>
<span><span class="va">eq_zone_results</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">buffer</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">test_pred</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">test_pred</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>.pred_with_eqz <span class="op">=</span> <span class="fu"><a href="https://probably.tidymodels.org/reference/make_class_pred.html">make_two_class_pred</a></span><span class="op">(</span><span class="va">.pred_class_1</span>, <span class="va">lvls</span>, buffer <span class="op">=</span> <span class="va">buffer</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">acc</span> <span class="op">&lt;-</span> <span class="va">test_pred</span> <span class="op">%&gt;%</span> <span class="fu">accuracy</span><span class="op">(</span><span class="va">class</span>, <span class="va">.pred_with_eqz</span><span class="op">)</span></span>
<span>  <span class="va">rep_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://probably.tidymodels.org/reference/reportable_rate.html">reportable_rate</a></span><span class="op">(</span><span class="va">test_pred</span><span class="op">$</span><span class="va">.pred_with_eqz</span><span class="op">)</span></span>
<span>  <span class="fu">tibble</span><span class="op">(</span>accuracy <span class="op">=</span> <span class="va">acc</span><span class="op">$</span><span class="va">.estimate</span>, reportable <span class="op">=</span> <span class="va">rep_rate</span>, buffer <span class="op">=</span> <span class="va">buffer</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Evaluate a sequence of buffers and plot the results. </span></span>
<span><span class="fu">map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.1</span>, length.out <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>, <span class="va">eq_zone_results</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">list_rbind</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">buffer</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"statistic"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">buffer</span>, y <span class="op">=</span> <span class="va">value</span>, lty <span class="op">=</span> <span class="va">statistic</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_step</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, lty <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-equivocal-zone-results_5686d894b12f02d80744fac426ddcfcf">
<div class="cell-output-display">
<div id="fig-equivocal-zone-results" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-equivocal-zone-results-1.png" class="img-fluid figure-img" style="width:80.0%" alt="The effect of equivocal zones on model performance. There is a slight increase in accuracy at the expense of a falling reportable rate."></p>
<figcaption class="figure-caption">Figure&nbsp;19.2: The effect of equivocal zones on model performance</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-equivocal-zone-results">Figure&nbsp;<span>19.2</span></a> shows us that accuracy improves by a few percentage points but at the cost of nearly 10% of predictions being unusable! The value of such a compromise depends on how the model predictions will be used.</p>
<p>This analysis focused on using the predicted class probability to disqualify points, since this is a fundamental measure of uncertainty in classification models. A slightly better approach would be to use the standard error of the class probability. Since we used a Bayesian model, the probability estimates we found are actually the mean of the posterior predictive distribution. In other words, the Bayesian model gives us a distribution for the class probability. Measuring the standard deviation of this distribution gives us a <em>standard error of prediction</em> of the probability. In most cases, this value is directly related to the mean class probability. You might recall that, for a Bernoulli random variable with probability <span class="math inline">\(p\)</span>, the variance is <span class="math inline">\(p(1-p)\)</span>. Because of this relationship, the standard error is largest when the probability is 50%. Instead of assigning an equivocal result using the class probability, we could instead use a cutoff on the standard error of prediction.</p>
<p>One important aspect of the standard error of prediction is that it takes into account more than just the class probability. In cases where there is significant extrapolation or aberrant predictor values, the standard error might increase. The benefit of using the standard error of prediction is that it might also flag predictions that are problematic (as opposed to simply uncertain). One reason we used the Bayesian model is that it naturally estimates the standard error of prediction; not many models can calculate this. For our test set, using <code>type = "pred_int"</code> will produce upper and lower limits and the <code>std_error</code> adds a column for that quantity. For 80% intervals:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-pred-int_9b2b3cb54ab796ab2bf1820435861f47">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_pred</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">test_pred</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">two_class_mod</span>, <span class="va">testing_set</span>, type <span class="op">=</span> <span class="st">"pred_int"</span>, std_error <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For our example where the model and data are well behaved, <a href="#fig-std-errors">Figure&nbsp;<span>19.3</span></a> shows the standard error of prediction across the space:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-std-errors_e84c6b24eee108fbe1acfc30acecf4dd">
<div class="cell-output-display">
<div id="fig-std-errors" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-std-errors-1.png" class="img-fluid figure-img" style="width:70.0%" alt="The effect of the standard error of prediction overlaid with the test set data. The region of large variation is very similar to the class boundary space. Additionally, there is a large amount of variation to the west of the inflection point of the boundary curve."></p>
<figcaption class="figure-caption">Figure&nbsp;19.3: The effect of the standard error of prediction overlaid with the test set data</figcaption></figure>
</div>
</div>
</div>
<p>Using the standard error as a measure to preclude samples from being predicted can also be applied to models with numeric outcomes. However, as shown in the next section, this may not always work.</p>
</section><section id="sec-applicability-domains" class="level2" data-number="19.2"><h2 data-number="19.2" class="anchored" data-anchor-id="sec-applicability-domains">
<span class="header-section-number">19.2</span> Determining Model Applicability</h2>
<p>Equivocal zones try to measure the reliability of a prediction based on the model outputs. It may be that model statistics, such as the standard error of prediction, cannot measure the impact of extrapolation, and so we need another way to assess whether to trust a prediction and answer, “Is our model applicable for predicting a specific data point?” Let’s take the Chicago train data used extensively in <a href="https://bookdown.org/max/FES/chicago-intro.html">Kuhn and Johnson (2019)</a> and first shown in <span class="quarto-unresolved-ref">?sec-examples-of-tidyverse-syntax</span>. The goal is to predict the number of customers entering the Clark and Lake train station each day.</p>
<p>The data set in the <span class="pkg">modeldata</span> package (a tidymodels package with example data sets) has daily values between enero 22, 2001 and agosto 28, 2016. Let’s create a small test set using the last two weeks of the data:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-chicago-data_79a404e0d21fbde172e7008714330d3e">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## loads both `Chicago` data set as well as `stations`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Chicago</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Chicago</span> <span class="op">&lt;-</span> <span class="va">Chicago</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">ridership</span>, <span class="va">date</span>, <span class="fu">one_of</span><span class="op">(</span><span class="va">stations</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Chicago</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Chicago_train</span> <span class="op">&lt;-</span> <span class="va">Chicago</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">14</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Chicago_test</span>  <span class="op">&lt;-</span> <span class="va">Chicago</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">13</span><span class="op">)</span><span class="op">:</span><span class="va">n</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main predictors are lagged ridership data at different train stations, including Clark and Lake, as well as the date. The ridership predictors are highly correlated with one another. In the following recipe, the date column is expanded into several new features, and the ridership predictors are represented using partial least squares (PLS) components. PLS <span class="citation" data-cites="Geladi:1986">(<a href="references.html#ref-Geladi:1986" role="doc-biblioref">Geladi and Kowalski 1986</a>)</span>, as we discussed in Section @ref(partial-least-squares), is a supervised version of principal component analysis where the new features have been decorrelated but are predictive of the outcome data.</p>
<p>Using the preprocessed data, we fit a standard linear model:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-chicago-model_637a64821bb63502a6542b3df01786b5">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">base_recipe</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="va">ridership</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">Chicago_train</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Create date features</span></span>
<span>  <span class="fu">step_date</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_holiday</span><span class="op">(</span><span class="va">date</span>, keep_original_cols <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Create dummy variables from factor columns</span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="co"># Remove any columns with a single unique value</span></span>
<span>  <span class="fu">step_zv</span><span class="op">(</span><span class="fu">all_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">stations</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">step_pls</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">stations</span>, num_comp <span class="op">=</span> <span class="fl">10</span>, outcome <span class="op">=</span> <span class="fu">vars</span><span class="op">(</span><span class="va">ridership</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_spec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">lm_wflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">base_recipe</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lm_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1902</span><span class="op">)</span></span>
<span><span class="va">lm_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">lm_wflow</span>, data <span class="op">=</span> <span class="va">Chicago_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How well do the data fit on the test set? We can <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> for the test set to find both predictions and prediction intervals:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-chicago-test-res_b774bf811d8179cd766398cee4001db9">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">res_test</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">Chicago_test</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">Chicago_test</span>, type <span class="op">=</span> <span class="st">"pred_int"</span><span class="op">)</span>,</span>
<span>    <span class="va">Chicago_test</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">res_test</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">date</span>, <span class="va">ridership</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 5</span></span>
<span><span class="co">##   date       ridership .pred .pred_lower .pred_upper</span></span>
<span><span class="co">##   &lt;date&gt;         &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 2016-08-15     20.6  20.3        16.2         24.5</span></span>
<span><span class="co">## 2 2016-08-16     21.0  21.3        17.1         25.4</span></span>
<span><span class="co">## 3 2016-08-17     21.0  21.4        17.3         25.6</span></span>
<span><span class="co">## 4 2016-08-18     21.3  21.4        17.3         25.5</span></span>
<span><span class="co">## 5 2016-08-19     20.4  20.9        16.7         25.0</span></span>
<span><span class="co">## 6 2016-08-20      6.22  7.52        3.34        11.7</span></span>
<span><span class="co">## # ℹ 8 more rows</span></span>
<span><span class="va">res_test</span> <span class="op">%&gt;%</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">ridership</span>, <span class="va">.pred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 3</span></span>
<span><span class="co">##   .metric .estimator .estimate</span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">## 1 rmse    standard       0.865</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are fairly good results. <a href="#fig-chicago-2016">Figure&nbsp;<span>19.4</span></a> visualizes the predictions along with 95% prediction intervals.</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-chicago-2016_2b688e3d92251a242a3fb5f23d272b40">
<div class="cell-output-display">
<div id="fig-chicago-2016" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-chicago-2016-1.png" class="img-fluid figure-img" style="width:80.0%" alt="Two weeks of 2016 predictions for the Chicago data along with 95% prediction intervals. The model fit the data fairly well with reasonable error estimates."></p>
<figcaption class="figure-caption">Figure&nbsp;19.4: Two weeks of 2016 predictions for the Chicago data along with 95% prediction intervals</figcaption></figure>
</div>
</div>
</div>
<p>Given the scale of the ridership numbers, these results look particularly good for such a simple model. If this model were deployed, how well would it have done a few years later in June 2020? The model successfully makes a prediction, as a predictive model almost always will when given input data:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-chicago-2020-res_1ee8d4f33fb31e1a3992bb02b2de0cf7">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">res_2020</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">Chicago_2020</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_fit</span>, <span class="va">Chicago_2020</span>, type <span class="op">=</span> <span class="st">"pred_int"</span><span class="op">)</span>,</span>
<span>    <span class="va">Chicago_2020</span></span>
<span>  <span class="op">)</span> </span>
<span></span>
<span><span class="va">res_2020</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">date</span>, <span class="fu">contains</span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 4</span></span>
<span><span class="co">##   date       .pred .pred_lower .pred_upper</span></span>
<span><span class="co">##   &lt;date&gt;     &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 2020-06-01 20.1        15.9         24.3</span></span>
<span><span class="co">## 2 2020-06-02 21.4        17.2         25.6</span></span>
<span><span class="co">## 3 2020-06-03 21.5        17.3         25.6</span></span>
<span><span class="co">## 4 2020-06-04 21.3        17.1         25.4</span></span>
<span><span class="co">## 5 2020-06-05 20.7        16.6         24.9</span></span>
<span><span class="co">## 6 2020-06-06  9.04        4.88        13.2</span></span>
<span><span class="co">## # ℹ 8 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The prediction intervals are about the same width, even though these data are well beyond the time period of the original training set. However, given the global pandemic in 2020, the performance on these data are abysmal:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-chicago-2020-stats_92fd9892f02fbb79c8f47d9b0b5a1938">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">res_2020</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">date</span>, <span class="va">ridership</span>, <span class="fu">starts_with</span><span class="op">(</span><span class="st">".pred"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 5</span></span>
<span><span class="co">##   date       ridership .pred .pred_lower .pred_upper</span></span>
<span><span class="co">##   &lt;date&gt;         &lt;dbl&gt; &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">## 1 2020-06-01     0.002 20.1        15.9         24.3</span></span>
<span><span class="co">## 2 2020-06-02     0.005 21.4        17.2         25.6</span></span>
<span><span class="co">## 3 2020-06-03     0.566 21.5        17.3         25.6</span></span>
<span><span class="co">## 4 2020-06-04     1.66  21.3        17.1         25.4</span></span>
<span><span class="co">## 5 2020-06-05     1.95  20.7        16.6         24.9</span></span>
<span><span class="co">## 6 2020-06-06     1.08   9.04        4.88        13.2</span></span>
<span><span class="co">## # ℹ 8 more rows</span></span>
<span><span class="va">res_2020</span> <span class="op">%&gt;%</span> <span class="fu">rmse</span><span class="op">(</span><span class="va">ridership</span>, <span class="va">.pred</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 3</span></span>
<span><span class="co">##   .metric .estimator .estimate</span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">## 1 rmse    standard        17.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can see this terrible model performance visually in <a href="#fig-chicago-2020">Figure&nbsp;<span>19.5</span></a>.</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-chicago-2020_93ea7b6e985ed24c7a1cc670e8d7ce0f">
<div class="cell-output-display">
<div id="fig-chicago-2020" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-chicago-2020-1.png" class="img-fluid figure-img" style="width:80.0%" alt="Two weeks of 2016 predictions for the Chicago data along with 95% prediction intervals. The model fit the data fairly well with reasonable error estimates."></p>
<figcaption class="figure-caption">Figure&nbsp;19.5: Two weeks of 2020 predictions for the Chicago data along with 95% prediction intervals</figcaption></figure>
</div>
</div>
</div>
<p>Confidence and prediction intervals for linear regression expand as the data become more and more removed from the center of the training set. However, that effect is not dramatic enough to flag these predictions as being poor.</p>
<div class="rmdwarning">
<p>Sometimes the statistics produced by models don’t measure the quality of predictions very well.</p>
</div>
<p>This situation can be avoided by having a secondary methodology that can quantify how applicable the model is for any new prediction (i.e., the model’s <em>applicability domain</em>). There are a variety of methods to compute an applicability domain model, such as <span class="citation" data-cites="Jaworska">Jaworska, Nikolova-Jeliazkova, and Aldenberg (<a href="references.html#ref-Jaworska" role="doc-biblioref">2005</a>)</span> or <span class="citation" data-cites="Netzeva">Netzeva et al. (<a href="references.html#ref-Netzeva" role="doc-biblioref">2005</a>)</span>. The approach used in this chapter is a fairly simple unsupervised method that attempts to measure how much (if any) a new data point is beyond the training data.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="rmdnote">
<p>The idea is to accompany a prediction with a score that measures how similar the new point is to the training set.</p>
</div>
<p>One method that works well uses principal component analysis (PCA) on the numeric predictor values. We’ll illustrate the process by using only two of the predictors that correspond to ridership at different stations (California and Austin stations). The training set are shown in panel (a) in <a href="#fig-pca-reference-dist">Figure&nbsp;<span>19.6</span></a>. The ridership data for these stations are highly correlated, and the two distributions shown in the scatter plot correspond to ridership on the weekends and week days.</p>
<p>The first step is to conduct PCA on the training data. The PCA scores for the training set are shown in panel (b) in <a href="#fig-pca-reference-dist">Figure&nbsp;<span>19.6</span></a>. Next, using these results, we measure the distance of each training set point to the center of the PCA data (panel (c) of <a href="#fig-pca-reference-dist">Figure&nbsp;<span>19.6</span></a>). We can then use this <em>reference distribution</em> (panel (d) of <a href="#fig-pca-reference-dist">Figure&nbsp;<span>19.6</span></a>) to estimate how far a data point is from the mainstream of the training data.</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-pca-reference-dist_c797a62935838ddbbb765f14699e84bd">
<div class="cell-output-display">
<div id="fig-pca-reference-dist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-pca-reference-dist-1.png" class="img-fluid figure-img" style="width:100.0%" alt="The PCA reference distribution based on the training set. The majority of the distances to the center of the PCA distribution are below a value of three."></p>
<figcaption class="figure-caption">Figure&nbsp;19.6: The PCA reference distribution based on the training set</figcaption></figure>
</div>
</div>
</div>
<p>For a new sample, the PCA scores are computed along with the distance to the center of the training set.</p>
<p>However, what does it mean when a new sample has a distance of <em>X</em>? Since the PCA components can have different ranges from data set to data set, there is no obvious limit to say that a distance is too large.</p>
<p>One approach is to treat the distances from the training set data as “normal.” For new samples, we can determine how the new distance compares to the range in the reference distribution (from the training set). A percentile can be computed for new samples that reflect how much of the training set is less extreme than the new samples.</p>
<div class="rmdnote">
<p>A percentile of 90% means that most of the training set data are closer to the data center than the new sample.</p>
</div>
<p>The plot in <a href="#fig-two-new-points">Figure&nbsp;<span>19.7</span></a> overlays a testing set sample (triangle and dashed line) and a 2020 sample (circle and solid line) with the PCA distances from the training set.</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-two-new-points_f5c639c48b8914c94a099f216651999a">
<div class="cell-output-display">
<div id="fig-two-new-points" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-two-new-points-1.png" class="img-fluid figure-img" style="width:100.0%" alt="The reference distribution with two new points: one using the test set and one from the 2020 data. The test set point is snugly within the data mainstream while the 2020 point is outside of the reference distribution."></p>
<figcaption class="figure-caption">Figure&nbsp;19.7: The reference distribution with two new points: one using the test set and one from the 2020 data</figcaption></figure>
</div>
</div>
</div>
<p>The test set point has a distance of 1.28. It is in the 51.8% percentile of the training set distribution, indicating that it is snugly within the mainstream of the training set.</p>
<p>The 2020 sample is farther from the center than any of the training set samples (with a percentile of 100%). This indicates the sample is very extreme and that its corresponding prediction would be a severe extrapolation (and probably should not be reported).</p>
<p>The <span class="pkg">applicable</span> package can develop an applicability domain model using PCA. We’ll use the 20 lagged station ridership predictors as inputs into the PCA analysis. There is an additional argument called <code>threshold</code> that determines how many components are used in the distance calculation. For our example, we’ll use a large value that indicates we should use enough components to account for 99% of the variation in the ridership predictors:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-apd-pca_68d6db190272d0b3c1c038654fd0ad20">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/applicable">applicable</a></span><span class="op">)</span></span>
<span><span class="va">pca_stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://applicable.tidymodels.org/reference/apd_pca.html">apd_pca</a></span><span class="op">(</span><span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">Chicago_train</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="fu">one_of</span><span class="op">(</span><span class="va">stations</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    threshold <span class="op">=</span> <span class="fl">0.99</span><span class="op">)</span></span>
<span><span class="va">pca_stat</span></span>
<span><span class="co">## # Predictors:</span></span>
<span><span class="co">##    20</span></span>
<span><span class="co">## # Principal Components:</span></span>
<span><span class="co">##    9 components were needed</span></span>
<span><span class="co">##    to capture at least 99% of the</span></span>
<span><span class="co">##    total variation in the predictors.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method plots the reference distribution. It has an optional argument for which data to plot. We’ll add a value of <code>distance</code> to plot only the training set distance distribution. This code generates the plot in <a href="#fig-ap-autoplot">Figure&nbsp;<span>19.8</span></a>:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-ref-dist_d740f615fbdd1187d175ca6ffbe8a3e3">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">pca_stat</span>, <span class="va">distance</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"distance"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/fig-ap-autoplot_74f7578466ee19e8809d8d20cd365b8f">
<div class="cell-output-display">
<div id="fig-ap-autoplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="19-when-should-you-trust-predictions_files/figure-html/fig-ap-autoplot-1.png" class="img-fluid figure-img" style="width:70.0%" alt="The results of using the `autoplot()` method on an applicable object."></p>
<figcaption class="figure-caption">Figure&nbsp;19.8: The results of using the <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> method on an applicable object</figcaption></figure>
</div>
</div>
</div>
<p>The x-axis shows the values of the distance and the y-axis displays the distribution’s percentiles. For example, half of the training set samples had distances less than 3.7.</p>
<p>To compute the percentiles for new data, the <code><a href="https://applicable.tidymodels.org/reference/score.html">score()</a></code> function works in the same way as <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-apd-test-scores_e5975e0df542a60a214e35257c8bb161">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://applicable.tidymodels.org/reference/score.html">score</a></span><span class="op">(</span><span class="va">pca_stat</span>, <span class="va">Chicago_test</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"distance"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 2</span></span>
<span><span class="co">##   distance distance_pctl</span></span>
<span><span class="co">##      &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1     4.88          66.7</span></span>
<span><span class="co">## 2     5.21          71.4</span></span>
<span><span class="co">## 3     5.19          71.1</span></span>
<span><span class="co">## 4     5.00          68.5</span></span>
<span><span class="co">## 5     4.36          59.3</span></span>
<span><span class="co">## 6     4.10          55.2</span></span>
<span><span class="co">## # ℹ 8 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These seem fairly reasonable. For the 2020 data:</p>
<div class="cell" data-layout-align="center" data-hash="19-when-should-you-trust-predictions_cache/html/trust-apd-2020-scores_d7c32eb6e0ac65d165e8ac8ab85d6318">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://applicable.tidymodels.org/reference/score.html">score</a></span><span class="op">(</span><span class="va">pca_stat</span>, <span class="va">Chicago_2020</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="fu">starts_with</span><span class="op">(</span><span class="st">"distance"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 14 × 2</span></span>
<span><span class="co">##   distance distance_pctl</span></span>
<span><span class="co">##      &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">## 1     9.39          99.8</span></span>
<span><span class="co">## 2     9.40          99.8</span></span>
<span><span class="co">## 3     9.30          99.7</span></span>
<span><span class="co">## 4     9.30          99.7</span></span>
<span><span class="co">## 5     9.29          99.7</span></span>
<span><span class="co">## 6    10.1            1  </span></span>
<span><span class="co">## # ℹ 8 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The 2020 distance values indicate that these predictor values are outside of the vast majority of data seen by the model at training time. These should be flagged so that the predictions are either not reported at all or viewed with skepticism.</p>
<div class="rmdnote">
<p>One important aspect of this analysis concerns which predictors are used to develop the applicability domain model. In our analysis, we used the raw predictor columns. However, in building the model, PLS score features were used in their place. Which of these should <code><a href="https://applicable.tidymodels.org/reference/apd_pca.html">apd_pca()</a></code> use? The <code><a href="https://applicable.tidymodels.org/reference/apd_pca.html">apd_pca()</a></code> function can also take a recipe as the input (instead of a formula) so that the distances reflect the PLS scores instead of the individual predictor columns. You can evaluate both methods to understand which one gives more relevant results.</p>
</div>
</section><section id="sec-trust-summary" class="level2" data-number="19.3"><h2 data-number="19.3" class="anchored" data-anchor-id="sec-trust-summary">
<span class="header-section-number">19.3</span> Chapter Summary</h2>
<p>This chapter showed two methods for evaluating whether predictions should be reported to the consumers of models. Equivocal zones deal with outcomes/predictions and can be helpful when the amount of uncertainty in a prediction is too large.</p>
<p>Applicability domain models deal with features/predictors and quantify the amount of extrapolation (if any) that occurs when making a prediction. This chapter showed a basic method using principal component analysis, although there are many other ways to measure applicability. The <span class="pkg">applicable</span> package also contains specialized methods for data sets where all of the predictors are binary. This method computes similarity scores between training set data points to define the reference distribution.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Bartley" class="csl-entry" role="listitem">
Bartley, E AND Schliep, M . AND Hanks. 2019. <span>“Identifying and Characterizing Extrapolation in Multivariate Response Data.”</span> <em>PLOS ONE</em> 14 (December): 1–20.
</div>
<div id="ref-Danowski524" class="csl-entry" role="listitem">
Danowski, T, J Aarons, J Hydovitz, and J Wingert. 1970. <span>“Utility of Equivocal Glucose Tolerances.”</span> <em>Diabetes</em> 19 (7): 524–26.
</div>
<div id="ref-Geladi:1986" class="csl-entry" role="listitem">
Geladi, P., and B Kowalski. 1986. <span>“Partial Least-Squares Regression: A Tutorial.”</span> <em>Analytica Chimica Acta</em> 185: 1–17.
</div>
<div id="ref-Jaworska" class="csl-entry" role="listitem">
Jaworska, J, N Nikolova-Jeliazkova, and T Aldenberg. 2005. <span>“QSAR Applicability Domain Estimation by Projection of the Training Set in Descriptor Space: A Review.”</span> <em>Alternatives to Laboratory Animals</em> 33 (5): 445–59.
</div>
<div id="ref-Kerleguer1783" class="csl-entry" role="listitem">
Kerleguer, A., J.-L. Koeck, M. Fabre, P. Gérôme, R. Teyssou, and V. Hervé. 2003. <span>“Use of Equivocal Zone in Interpretation of Results of the Amplified <span>Mycobacterium Tuberculosis</span> Direct Test for Diagnosis of Tuberculosis.”</span> <em>Journal of Clinical Microbiology</em> 41 (4): 1783–84.
</div>
<div id="ref-Netzeva" class="csl-entry" role="listitem">
Netzeva, T, A Worth, T Aldenberg, R Benigni, M Cronin, P Gramatica, J Jaworska, et al. 2005. <span>“Current Status of Methods for Defining the Applicability Domain of (Quantitative) Structure-Activity Relationships: The Report and Recommendations of ECVAM Workshop 52.”</span> <em>Alternatives to Laboratory Animals</em> 33 (2): 155–73.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><span class="citation" data-cites="Bartley">Bartley (<a href="references.html#ref-Bartley" role="doc-biblioref">2019</a>)</span> shows yet another method and applies it to ecological studies.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./18-explaining-models-and-predictions.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Explaining Models and Predictions</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./20-ensemble-models.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Ensembles of Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">Modelado Ordenado con R fue escrito por Max Kuhn, y Julia Silge.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Este libro fue creado usando <a href="https://quarto.org/">Quarto</a>.</div>
  </div>
</footer>


</body></html>